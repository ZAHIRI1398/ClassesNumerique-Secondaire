{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>{% if exercise %}Modifier{% else %}Créer{% endif %} un exercice de légende</h2>
    
    <div class="alert alert-info" role="alert">
        <i class="fas fa-info-circle"></i>
        Pour créer un exercice de légende :
        <ol>
            <li>Entrez un titre descriptif pour l'exercice</li>
            <li>Ajoutez une description qui explique la consigne aux élèves</li>
            <li>Uploadez une image principale (obligatoire)</li>
            <li>Cliquez sur l'image pour placer des zones de légende</li>
            <li>Pour chaque zone, saisissez le texte de la légende correspondante</li>
        </ol>
    </div>

    <form method="POST" class="mt-4" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="mb-3">
            <label for="title" class="form-label">Titre</label>
            <input type="text" class="form-control" id="title" name="title" value="{{ exercise.title if exercise else '' }}" required>
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3" required>{{ exercise.description if exercise else '' }}</textarea>
        </div>

        <!-- Section d'upload d'image principale -->
        <div class="mb-4">
            <label class="form-label">Image principale (obligatoire)</label>
            {% if exercise and exercise.image_path %}
            <div class="current-image mb-3">
                <p class="text-muted mb-2">Image actuelle :</p>
                <img src="{{ url_for('static', filename='uploads/' + exercise.image_path) }}" 
                     alt="Image actuelle" 
                     class="img-thumbnail" 
                     style="max-width: 300px; max-height: 300px;">
                <p class="small text-muted mt-1">{{ exercise.image_path }}</p>
            </div>
            {% endif %}
            <input type="file" 
                   class="form-control" 
                   id="legend_main_image" 
                   name="legend_main_image" 
                   accept=".jpg,.jpeg,.png,.gif"
                   onchange="previewMainImage(this)"
                   {% if not exercise %}required{% endif %}>
            <div class="form-text">Ajoutez l'image principale à légender (formats acceptés : JPG, PNG, GIF, max 5MB)</div>
            <div id="main-image-preview" class="mt-2" style="display: none;">
                <img id="preview-main-img" src="" alt="Prévisualisation" class="img-thumbnail" style="max-width: 300px; max-height: 300px;">
                <p id="preview-main-filename" class="small text-muted mt-1"></p>
            </div>
        </div>

        <!-- Mode d'exercice légende -->
        <div class="mb-4">
            <label class="form-label">Mode d'exercice</label>
            <div class="row">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <input type="radio" class="form-check-input" id="mode_classic" name="legend_mode" value="classic" checked onchange="updateLegendMode()">
                            <label for="mode_classic" class="form-check-label d-block mt-2">
                                <i class="fas fa-map-marker-alt fa-2x text-primary mb-2"></i>
                                <h6>Classique</h6>
                                <small class="text-muted">Placer des légendes sur des points précis de l'image</small>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <input type="radio" class="form-check-input" id="mode_grid" name="legend_mode" value="grid" onchange="updateLegendMode()">
                            <label for="mode_grid" class="form-check-label d-block mt-2">
                                <i class="fas fa-th fa-2x text-success mb-2"></i>
                                <h6>Quadrillage</h6>
                                <small class="text-muted">Déplacer des éléments vers des cases spécifiques</small>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <input type="radio" class="form-check-input" id="mode_spatial" name="legend_mode" value="spatial" onchange="updateLegendMode()">
                            <label for="mode_spatial" class="form-check-label d-block mt-2">
                                <i class="fas fa-home fa-2x text-warning mb-2"></i>
                                <h6>Spatial</h6>
                                <small class="text-muted">Placer des éléments dans des zones définies</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section des instructions -->
        <div class="mb-3">
            <label for="legend_instructions" class="form-label">Instructions</label>
            <textarea class="form-control" id="legend_instructions" name="legend_instructions" rows="2" placeholder="Placez les légendes aux bons endroits sur l'image.">{{ content.instructions if content and content.instructions else '' }}</textarea>
            <div class="form-text">Instructions qui seront affichées aux élèves</div>
        </div>

        <!-- Zone interactive pour placer les légendes -->
        <div class="mb-4">
            <label class="form-label">Zones de légende</label>
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Comment ajouter des zones :</strong>
                <ol class="mb-0 mt-2">
                    <li>Uploadez d'abord une image principale</li>
                    <li>Cliquez sur l'image pour placer une zone de légende</li>
                    <li>Saisissez le texte de la légende dans le champ qui apparaît</li>
                    <li>Répétez pour ajouter d'autres zones</li>
                </ol>
            </div>
            
            <div id="legend-editor" class="border rounded p-3" style="min-height: 400px; background-color: #f8f9fa;">
                <div id="image-container" style="position: relative; display: inline-block;">
                    {% if exercise and content and content.main_image %}
                    <img id="editor-image" 
                         src="{{ url_for('static', filename=content.main_image.replace('static/', '')) }}" 
                         alt="Image à légender" 
                         style="max-width: 100%; height: auto; cursor: crosshair;">
                    
                    {% for zone in content.zones %}
                    <div class="legend-zone-marker" 
                         data-zone-id="{{ zone.id }}"
                         style="position: absolute; left: {{ zone.x }}px; top: {{ zone.y }}px; width: 20px; height: 20px; background-color: #ff4444; border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); cursor: pointer;"
                         title="{{ zone.legend }}">
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">Uploadez une image pour commencer à placer des zones de légende</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Section Mode Quadrillage -->
        <div id="grid-mode-section" class="mb-4" style="display: none;">
            <label class="form-label">Configuration du quadrillage</label>
            <div class="row">
                <div class="col-md-6">
                    <label for="grid_rows" class="form-label">Nombre de lignes</label>
                    <input type="number" class="form-control" id="grid_rows" name="grid_rows" min="2" max="10" value="4">
                </div>
                <div class="col-md-6">
                    <label for="grid_cols" class="form-label">Nombre de colonnes</label>
                    <input type="number" class="form-control" id="grid_cols" name="grid_cols" min="2" max="10" value="4">
                </div>
            </div>
            
            <div class="mt-3">
                <label class="form-label">Éléments à déplacer</label>
                <div id="grid-elements-container">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Ajoutez les éléments (images ou textes) que les élèves devront déplacer vers les bonnes cases du quadrillage.
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addGridElement()">Ajouter un élément</button>
                </div>
            </div>
        </div>

        <!-- Section Mode Spatial -->
        <div id="spatial-mode-section" class="mb-4" style="display: none;">
            <label class="form-label">Configuration spatiale</label>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Définissez les zones de dépôt sur l'image et les éléments à placer.
            </div>
            
            <div class="mb-3">
                <label class="form-label">Zones de dépôt</label>
                <div id="spatial-zones-container">
                    <p class="text-muted">Cliquez sur l'image pour définir les zones où les élèves pourront déposer les éléments.</p>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Éléments à placer</label>
                <div id="spatial-elements-container">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Ajoutez les éléments (images ou textes) que les élèves devront placer dans les bonnes zones.
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addSpatialElement()">Ajouter un élément</button>
                </div>
            </div>
        </div>

        <!-- Liste des zones créées -->
        <div class="mb-4">
            <label class="form-label">Légendes créées</label>
            <div id="zones-list" class="border rounded p-3" style="min-height: 100px; background-color: #f8f9fa;">
                {% if exercise and content and content.zones %}
                {% for zone in content.zones %}
                <div class="zone-item mb-2 p-2 bg-white border rounded" data-zone-id="{{ zone.id }}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Zone {{ loop.index }} :</strong> {{ zone.legend }}
                            <small class="text-muted">(Position: {{ zone.x }}, {{ zone.y }})</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeZone({{ zone.id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <input type="hidden" name="zone_{{ zone.id }}_x" value="{{ zone.x }}">
                    <input type="hidden" name="zone_{{ zone.id }}_y" value="{{ zone.y }}">
                    <input type="hidden" name="zone_{{ zone.id }}_legend" value="{{ zone.legend }}">
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted">Aucune zone de légende créée. Cliquez sur l'image pour en ajouter.</p>
                {% endif %}
            </div>
        </div>

        <div class="mb-3">
            <label for="difficulty" class="form-label">Difficulté</label>
            <select class="form-select" id="difficulty" name="difficulty" required>
                <option value="easy" {% if exercise and exercise.difficulty == 'easy' %}selected{% endif %}>Facile</option>
                <option value="medium" {% if exercise and exercise.difficulty == 'medium' %}selected{% endif %}>Moyen</option>
                <option value="hard" {% if exercise and exercise.difficulty == 'hard' %}selected{% endif %}>Difficile</option>
            </select>
        </div>

        {% if courses %}
        <div class="mb-3">
            <label for="course" class="form-label">Cours</label>
            <select class="form-select" id="course" name="course_id">
                <option value="">Aucun cours</option>
                {% for course in courses %}
                    <option value="{{ course.id }}" {% if exercise and exercise.course_id == course.id %}selected{% endif %}>
                        {{ course.title }}
                    </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Enregistrer
        </button>
        <a href="{{ url_for('exercise.exercise_library') }}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Annuler
        </a>
    </form>
</div>

<!-- Modal pour saisir la légende -->
<div class="modal fade" id="legendModal" tabindex="-1" aria-labelledby="legendModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="legendModalLabel">Ajouter une légende</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="legendText" class="form-label">Texte de la légende</label>
                    <input type="text" class="form-control" id="legendText" placeholder="Saisissez le texte de la légende">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveLegend()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<script>
let zoneCounter = {{ content.zones|length if content and content.zones else 0 }};
let currentZone = null;
let gridElementCounter = 0;
let spatialElementCounter = 0;

// Fonction pour changer le mode d'exercice
function updateLegendMode() {
    const classicMode = document.getElementById('mode_classic').checked;
    const gridMode = document.getElementById('mode_grid').checked;
    const spatialMode = document.getElementById('mode_spatial').checked;
    
    // Masquer toutes les sections
    document.getElementById('grid-mode-section').style.display = 'none';
    document.getElementById('spatial-mode-section').style.display = 'none';
    
    // Afficher la section correspondante
    if (gridMode) {
        document.getElementById('grid-mode-section').style.display = 'block';
        updateInstructions('Déplacez les éléments vers les bonnes cases du quadrillage.');
    } else if (spatialMode) {
        document.getElementById('spatial-mode-section').style.display = 'block';
        updateInstructions('Placez les éléments dans les bonnes zones.');
    } else {
        updateInstructions('Placez les légendes aux bons endroits sur l\'image.');
    }
}

// Fonction pour mettre à jour les instructions
function updateInstructions(text) {
    const instructionsField = document.getElementById('legend_instructions');
    if (instructionsField.value === '' || instructionsField.value === instructionsField.placeholder) {
        instructionsField.value = text;
    }
}

// Fonction pour ajouter un élément de quadrillage
function addGridElement() {
    gridElementCounter++;
    const container = document.getElementById('grid-elements-container');
    
    const elementDiv = document.createElement('div');
    elementDiv.className = 'card mb-3';
    elementDiv.innerHTML = `
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Type d'élément</label>
                    <select class="form-select" name="grid_element_${gridElementCounter}_type" onchange="toggleGridElementInput(${gridElementCounter}, this.value)">
                        <option value="text">Texte</option>
                        <option value="image">Image</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Position cible (ligne, colonne)</label>
                    <div class="row">
                        <div class="col-6">
                            <input type="number" class="form-control" name="grid_element_${gridElementCounter}_target_row" placeholder="Ligne" min="1">
                        </div>
                        <div class="col-6">
                            <input type="number" class="form-control" name="grid_element_${gridElementCounter}_target_col" placeholder="Colonne" min="1">
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <div id="grid_element_${gridElementCounter}_text_input">
                    <label class="form-label">Texte</label>
                    <input type="text" class="form-control" name="grid_element_${gridElementCounter}_text" placeholder="Texte à afficher">
                </div>
                <div id="grid_element_${gridElementCounter}_image_input" style="display: none;">
                    <label class="form-label">Image</label>
                    <input type="file" class="form-control" name="grid_element_${gridElementCounter}_image" accept=".jpg,.jpeg,.png,.gif">
                </div>
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeGridElement(this)">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(elementDiv);
}

// Fonction pour basculer entre texte et image pour les éléments de quadrillage
function toggleGridElementInput(elementId, type) {
    const textInput = document.getElementById(`grid_element_${elementId}_text_input`);
    const imageInput = document.getElementById(`grid_element_${elementId}_image_input`);
    
    if (type === 'text') {
        textInput.style.display = 'block';
        imageInput.style.display = 'none';
    } else {
        textInput.style.display = 'none';
        imageInput.style.display = 'block';
    }
}

// Fonction pour supprimer un élément de quadrillage
function removeGridElement(button) {
    button.closest('.card').remove();
}

// Fonction pour ajouter un élément spatial
function addSpatialElement() {
    spatialElementCounter++;
    const container = document.getElementById('spatial-elements-container');
    
    const elementDiv = document.createElement('div');
    elementDiv.className = 'card mb-3';
    elementDiv.innerHTML = `
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Type d'élément</label>
                    <select class="form-select" name="spatial_element_${spatialElementCounter}_type" onchange="toggleSpatialElementInput(${spatialElementCounter}, this.value)">
                        <option value="text">Texte</option>
                        <option value="image">Image</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Zone cible</label>
                    <select class="form-select" name="spatial_element_${spatialElementCounter}_target_zone">
                        <option value="">Sélectionner une zone</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <div id="spatial_element_${spatialElementCounter}_text_input">
                    <label class="form-label">Texte</label>
                    <input type="text" class="form-control" name="spatial_element_${spatialElementCounter}_text" placeholder="Texte à afficher">
                </div>
                <div id="spatial_element_${spatialElementCounter}_image_input" style="display: none;">
                    <label class="form-label">Image</label>
                    <input type="file" class="form-control" name="spatial_element_${spatialElementCounter}_image" accept=".jpg,.jpeg,.png,.gif">
                </div>
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeSpatialElement(this)">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(elementDiv);
}

// Fonction pour basculer entre texte et image pour les éléments spatiaux
function toggleSpatialElementInput(elementId, type) {
    const textInput = document.getElementById(`spatial_element_${elementId}_text_input`);
    const imageInput = document.getElementById(`spatial_element_${elementId}_image_input`);
    
    if (type === 'text') {
        textInput.style.display = 'block';
        imageInput.style.display = 'none';
    } else {
        textInput.style.display = 'none';
        imageInput.style.display = 'block';
    }
}

// Fonction pour supprimer un élément spatial
function removeSpatialElement(button) {
    button.closest('.card').remove();
}

// Fonction de prévisualisation d'image principale
function previewMainImage(input) {
    const preview = document.getElementById('main-image-preview');
    const previewImg = document.getElementById('preview-main-img');
    const previewFilename = document.getElementById('preview-main-filename');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewFilename.textContent = input.files[0].name;
            preview.style.display = 'block';
            
            // Remplacer l'image dans l'éditeur
            const editorImage = document.getElementById('editor-image');
            if (editorImage) {
                editorImage.src = e.target.result;
            } else {
                // Créer l'image dans l'éditeur
                const imageContainer = document.getElementById('image-container');
                imageContainer.innerHTML = `
                    <img id="editor-image" 
                         src="${e.target.result}" 
                         alt="Image à légender" 
                         style="max-width: 100%; height: auto; cursor: crosshair;"
                         onclick="addZone(event)">
                `;
            }
        };
        
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.style.display = 'none';
    }
}

// Fonction pour ajouter une zone de légende
function addZone(event) {
    const rect = event.target.getBoundingClientRect();
    const x = event.offsetX;
    const y = event.offsetY;
    
    currentZone = {
        id: zoneCounter,
        x: x,
        y: y
    };
    
    // Ouvrir le modal pour saisir la légende
    const modal = new bootstrap.Modal(document.getElementById('legendModal'));
    modal.show();
}

// Fonction pour sauvegarder la légende
function saveLegend() {
    const legendText = document.getElementById('legendText').value.trim();
    
    if (!legendText) {
        alert('Veuillez saisir un texte pour la légende.');
        return;
    }
    
    if (!currentZone) {
        alert('Erreur : aucune zone sélectionnée.');
        return;
    }
    
    // Ajouter le marqueur visuel sur l'image
    const imageContainer = document.getElementById('image-container');
    const marker = document.createElement('div');
    marker.className = 'legend-zone-marker';
    marker.dataset.zoneId = currentZone.id;
    marker.style.cssText = `
        position: absolute; 
        left: ${currentZone.x}px; 
        top: ${currentZone.y}px; 
        width: 20px; 
        height: 20px; 
        background-color: #ff4444; 
        border: 2px solid #fff; 
        border-radius: 50%; 
        transform: translate(-50%, -50%); 
        cursor: pointer;
    `;
    marker.title = legendText;
    imageContainer.appendChild(marker);
    
    // Ajouter l'élément dans la liste des zones
    const zonesList = document.getElementById('zones-list');
    const zoneItem = document.createElement('div');
    zoneItem.className = 'zone-item mb-2 p-2 bg-white border rounded';
    zoneItem.dataset.zoneId = currentZone.id;
    zoneItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong>Zone ${zoneCounter + 1} :</strong> ${legendText}
                <small class="text-muted">(Position: ${currentZone.x}, ${currentZone.y})</small>
            </div>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeZone(${currentZone.id})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <input type="hidden" name="zone_${currentZone.id}_x" value="${currentZone.x}">
        <input type="hidden" name="zone_${currentZone.id}_y" value="${currentZone.y}">
        <input type="hidden" name="zone_${currentZone.id}_legend" value="${legendText}">
    `;
    
    // Supprimer le message "Aucune zone" s'il existe
    const noZonesMessage = zonesList.querySelector('p.text-muted');
    if (noZonesMessage) {
        noZonesMessage.remove();
    }
    
    zonesList.appendChild(zoneItem);
    
    // Incrémenter le compteur et réinitialiser
    zoneCounter++;
    currentZone = null;
    
    // Fermer le modal et vider le champ
    const modal = bootstrap.Modal.getInstance(document.getElementById('legendModal'));
    modal.hide();
    document.getElementById('legendText').value = '';
}

// Fonction pour supprimer une zone
function removeZone(zoneId) {
    // Supprimer le marqueur visuel
    const marker = document.querySelector(`[data-zone-id="${zoneId}"]`);
    if (marker) {
        marker.remove();
    }
    
    // Supprimer l'élément de la liste
    const zoneItem = document.querySelector(`.zone-item[data-zone-id="${zoneId}"]`);
    if (zoneItem) {
        zoneItem.remove();
    }
    
    // Vérifier s'il reste des zones
    const remainingZones = document.querySelectorAll('.zone-item');
    if (remainingZones.length === 0) {
        const zonesList = document.getElementById('zones-list');
        zonesList.innerHTML = '<p class="text-muted">Aucune zone de légende créée. Cliquez sur l\'image pour en ajouter.</p>';
    }
}

// Initialiser l'éditeur au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const editorImage = document.getElementById('editor-image');
    if (editorImage) {
        editorImage.addEventListener('click', addZone);
    }
});
</script>
{% endblock %}
