{% extends "base.html" %}

{% block title %}{{ exercise.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- En-tête de l'exercice -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>
                        {{ exercise.title }}
                    </h3>
                    <p class="mb-0 mt-2">{{ exercise.description }}</p>
                </div>
            </div>

            <!-- Barre de progression -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Progression</span>
                        <span id="card-counter">1 / {{ content.cards|length }}</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-success" id="progress-bar" role="progressbar" 
                             style="width: {{ (1 / content.cards|length * 100)|round }}%"></div>
                    </div>
                </div>
            </div>

            <!-- Carte Flashcard -->
            <div class="card shadow-lg" id="flashcard-container">
                <div class="card-body text-center p-5">
                    <!-- Image de la carte -->
                    <div id="card-image-container" class="mb-4">
                        {% if content.cards[0].image %}
                        <img src="{{ url_for('static', filename=content.cards[0].image.replace('static/', '')) }}" 
                             alt="Image de la carte" class="img-fluid rounded" 
                             style="max-height: 300px;" id="card-image">
                        {% endif %}
                    </div>

                    <!-- Question -->
                    <h4 class="card-title mb-4" id="card-question">
                        {{ content.cards[0].question }}
                    </h4>

                    <!-- Zone de réponse -->
                    <div class="mb-4">
                        <input type="text" class="form-control form-control-lg text-center" 
                               id="user-answer" placeholder="Votre réponse..." autocomplete="off">
                    </div>

                    <!-- Boutons d'action -->
                    <div class="mb-3">
                        <button class="btn btn-primary btn-lg me-2" id="verify-btn" onclick="verifyAnswer()">
                            <i class="fas fa-check me-2"></i>Vérifier
                        </button>
                        <button class="btn btn-success btn-lg" id="next-btn" onclick="nextCard()" style="display: none;">
                            <i class="fas fa-arrow-right me-2"></i>Suivant
                        </button>
                    </div>

                    <!-- Feedback -->
                    <div id="feedback" class="alert" style="display: none;"></div>
                </div>
            </div>

            <!-- Bouton de fin -->
            <div class="text-center mt-4" id="finish-section" style="display: none;">
                <button class="btn btn-danger btn-lg" onclick="finishExercise()">
                    <i class="fas fa-flag-checkered me-2"></i>Terminer l'exercice
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Données des cartes
const cards = {{ content.cards|tojson|safe }};
let currentCardIndex = 0;
let correctAnswers = 0;
let userAnswers = [];

// Éléments DOM
const cardImage = document.getElementById('card-image');
const cardImageContainer = document.getElementById('card-image-container');
const cardQuestion = document.getElementById('card-question');
const userAnswerInput = document.getElementById('user-answer');
const verifyBtn = document.getElementById('verify-btn');
const nextBtn = document.getElementById('next-btn');
const feedback = document.getElementById('feedback');
const cardCounter = document.getElementById('card-counter');
const progressBar = document.getElementById('progress-bar');
const finishSection = document.getElementById('finish-section');

function updateCard() {
    const card = cards[currentCardIndex];
    
    // Mettre à jour la question
    cardQuestion.textContent = card.question;
    
    // Mettre à jour l'image
    if (card.image) {
        cardImage.src = `/static/${card.image.replace('static/', '')}`;
        cardImageContainer.style.display = 'block';
    } else {
        cardImageContainer.style.display = 'none';
    }
    
    // Mettre à jour le compteur et la progression
    cardCounter.textContent = `${currentCardIndex + 1} / ${cards.length}`;
    const progressPercent = ((currentCardIndex + 1) / cards.length) * 100;
    progressBar.style.width = `${progressPercent}%`;
}

function verifyAnswer() {
    const userAnswer = userAnswerInput.value.trim().toLowerCase();
    const correctAnswer = cards[currentCardIndex].answer.toLowerCase();
    
    // Enregistrer la réponse
    userAnswers.push({
        cardIndex: currentCardIndex,
        userAnswer: userAnswerInput.value.trim(),
        correctAnswer: cards[currentCardIndex].answer,
        isCorrect: userAnswer === correctAnswer
    });
    
    // Afficher le feedback
    if (userAnswer === correctAnswer) {
        feedback.textContent = '✅ Correct ! Bien joué !';
        feedback.className = 'alert alert-success';
        correctAnswers++;
    } else {
        feedback.textContent = `❌ Incorrect. La bonne réponse était : ${cards[currentCardIndex].answer}`;
        feedback.className = 'alert alert-danger';
    }
    
    feedback.style.display = 'block';
    userAnswerInput.disabled = true;
    verifyBtn.style.display = 'none';
    
    // Afficher le bouton suivant ou terminer
    if (currentCardIndex < cards.length - 1) {
        nextBtn.style.display = 'inline-block';
        nextBtn.focus();
    } else {
        finishSection.style.display = 'block';
    }
}

function nextCard() {
    currentCardIndex++;
    
    // Réinitialiser l'interface
    userAnswerInput.value = '';
    userAnswerInput.disabled = false;
    feedback.style.display = 'none';
    verifyBtn.style.display = 'inline-block';
    nextBtn.style.display = 'none';
    
    // Mettre à jour la carte
    updateCard();
    userAnswerInput.focus();
}

function finishExercise() {
    // Calculer le score
    const score = Math.round((correctAnswers / cards.length) * 100);
    
    // Envoyer les résultats au serveur
    fetch(`/exercise/{{ exercise.id }}/submit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            exercise_id: {{ exercise.id }},
            answers: userAnswers,
            score: score,
            exercise_type: 'flashcards'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Exercice terminé ! Score : ${score}%`);
            window.location.href = '/student/dashboard';
        } else {
            alert('Erreur lors de la sauvegarde : ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la soumission');
    });
}

// Navigation au clavier
userAnswerInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        if (verifyBtn.style.display !== 'none') {
            verifyAnswer();
        } else if (nextBtn.style.display !== 'none') {
            nextCard();
        }
    }
});

// Initialiser la première carte
updateCard();
userAnswerInput.focus();
</script>
{% endblock %}
