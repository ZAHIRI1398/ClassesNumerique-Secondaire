{% extends "edit_exercise.html" %}

{% block title %}Modifier un exercice d'étiquetage d'image{% endblock %}

{% block content %}
<!-- Initialisation des variables JavaScript pour les étiquettes et zones existantes -->
<!-- Génération des données JSON par Jinja2 en dehors du script JavaScript -->
<script type="application/json" id="labels-data">
{% if content and content.labels %}
{{ content.labels|tojson|safe }}
{% else %}
[]
{% endif %}
</script>

<script type="application/json" id="zones-data">
{% if content and content.zones %}
[
    {% for zone in content.zones %}
    {
        "x": {{ zone.x }},
        "y": {{ zone.y }},
        "label": {{ zone.label|tojson|safe }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
]
{% else %}
[]
{% endif %}
</script>

<script>
    // Initialiser les variables avec les données existantes
    // Récupérer les données JSON depuis les éléments script
    var existingLabels = JSON.parse(document.getElementById('labels-data').textContent);
    var existingZones = JSON.parse(document.getElementById('zones-data').textContent);
    
    // Afficher les données chargées dans la console
    if (existingLabels.length > 0) {
        console.log('Étiquettes chargées:', existingLabels);
    }
    
    if (existingZones.length > 0) {
        console.log('Zones chargées:', existingZones);
    }
</script>
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Modifier un exercice d'étiquetage d'image</h4>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <!-- Titre -->
                        <div class="mb-3">
                            <label for="title" class="form-label">Titre</label>
                            <input type="text" class="form-control" id="title" name="title" value="{{ exercise.title }}" required>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ exercise.description }}</textarea>
                        </div>

                        <!-- Note: Le champ d'image optionnelle a été supprimé pour éviter la confusion avec l'image principale à légender -->
                        <input type="hidden" name="remove_exercise_image" value="true">


                        <!-- INTERFACES ANCIENNES SUPPRIMÉES - Seule l'interface moderne ci-dessous est conservée -->

                        <!-- ===== INTERFACE INTERACTIVE MODERNE ===== -->
                        
                        <!-- Section d'upload d'image principale à légender -->
                        <div class="mb-4">
                            <h5 class="text-primary">
                                <i class="fas fa-image"></i> Image principale à légender
                            </h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>Instructions :</strong> Téléversez l'image principale sur laquelle les élèves placeront les étiquettes.
                            </div>
                            
                            <!-- Affichage de l'image actuelle si elle existe -->
                            {% if content and content.main_image %}
                            <div class="current-image mb-3" id="current-image-container">
                                <p class="text-muted mb-2">Image principale actuelle :</p>
                                <img src="{{ content.main_image }}?v={{ range(100000, 999999) | random }}" 
                                     alt="Image principale" 
                                     onerror="this.onerror=null; this.src='/static/images/placeholder-image.png'; this.style.opacity='0.7';"
                                     style="max-width: 300px; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div class="mt-2">
                                    <small class="text-muted">Fichier : {{ content.main_image }}</small>
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-danger btn-sm" id="remove-main-image-btn">
                                        <i class="fas fa-trash"></i> Supprimer l'image
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" name="remove_main_image" id="remove_main_image" value="false">
                            {% endif %}
                            
                            <input type="file" class="form-control" id="main_image" name="main_image" accept="image/*" onchange="previewMainImage(this)">
                            <div class="form-text">
                                {% if content and content.main_image %}
                                    Sélectionnez une nouvelle image pour remplacer l'image actuelle, ou laissez vide pour conserver l'image existante.
                                {% else %}
                                    Ajoutez l'image principale sur laquelle les élèves placeront les étiquettes (formats acceptés : JPG, PNG, GIF).
                                {% endif %}
                            </div>
                            
                            <!-- Zone de prévisualisation pour nouvelle image -->
                            <div id="main-image-preview" class="mt-3"></div>
                            <div id="image-upload-status" class="form-text"></div>
                        </div>
                        
                        <!-- Étiquettes disponibles -->
                        <div class="mb-4">
                            <h5 class="text-primary">
                                <i class="fas fa-tags"></i> Étiquettes disponibles
                            </h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>Instructions :</strong> Ajoutez les étiquettes que les élèves devront placer sur l'image.
                            </div>
                            
                            <div id="labels-list" class="mb-3">
                                <!-- Les étiquettes existantes seront chargées ici -->
                            </div>
                            
                            <button type="button" id="add-label-btn" class="btn btn-success" onclick="addNewLabel()">
                                <i class="fas fa-plus"></i> Ajouter une étiquette
                            </button>
                        </div>

                        <!-- Zones de placement -->
                        <div class="mb-4">
                            <h5 class="text-primary">
                                <i class="fas fa-crosshairs"></i> Zones de placement
                            </h5>
                            <div class="alert alert-warning">
                                <i class="fas fa-mouse-pointer"></i>
                                <strong>Instructions :</strong> Cliquez sur l'image ci-dessous pour définir où placer chaque étiquette.
                            </div>
                            
                            <!-- Image interactive -->
                            <div id="interactive-zone" class="border rounded p-3 mb-3" style="background-color: #f8f9fa;">
                                {% if content and content.main_image %}
                                <div class="position-relative d-inline-block">
                                    <img id="main-image" 
                                         src="{% if content.main_image.startswith('/static/uploads/') %}
                                                {{ url_for('uploaded_file', filename=content.main_image.replace('/static/uploads/','').lstrip('/') ) }}
                                              {% elif content.main_image.startswith('/static/') %}
                                                {{ content.main_image }}
                                              {% elif content.main_image.startswith('/') %}
                                                {{ content.main_image }}
                                              {% else %}
                                                {{ get_image_url(content.main_image, 'image_labeling') }}
                                              {% endif %}" 
                                         alt="Image à légender" 
                                         class="img-fluid border rounded"
                                         style="max-width: 100%; cursor: crosshair;">
                                    
                                    <!-- Les zones seront ajoutées ici dynamiquement -->
                                    <div id="zones-overlay"></div>
                                </div>
                                {% else %}
                                <div class="text-center text-muted p-5">
                                    <i class="fas fa-image fa-3x mb-3"></i>
                                    <p>L'image principale sera affichée ici pour définir les zones</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Résumé des zones -->
                            <div id="zones-summary" class="mt-3">
                                <h6>Zones définies :</h6>
                                <div id="zones-list-display">
                                    <!-- Les zones seront listées ici -->
                                </div>
                            </div>
                        </div>

                        <!-- Champs cachés pour la soumission -->
                        <div id="hidden-fields">
                            <!-- Les champs cachés seront générés ici par JavaScript -->
                        </div>

                        <!-- Boutons -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-success btn-lg me-3">
                                <i class="fas fa-save"></i> Sauvegarder
                            </button>
                            <a href="{{ url_for('exercise_library') }}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-arrow-left"></i> Annuler
                            </a>
                        </div>
                        <script>
// VERSION SIMPLIFIÉE FINALE - Cache Bypass 2025
console.log('=== SCRIPT FINAL CACHE BYPASS ===');

// Attendre que la page soit complètement chargée
window.addEventListener('load', function() {
    console.log('=== PAGE CHARGÉE - RECHERCHE BOUTON ===');
    
    // Rechercher le bouton de suppression
    const btn = document.getElementById('remove-main-image-btn');
    console.log('Bouton trouvé:', btn);
    
    if (btn) {
        console.log('=== AJOUT ÉVÉNEMENT CLIC ===');
        btn.onclick = function(e) {
            e.preventDefault();
            console.log('=== CLIC DÉTECTÉ ===');
            
            // Suppression directe sans confirm() pour éviter les problèmes
            console.log('=== SUPPRESSION AUTOMATIQUE ===');
            
            // Marquer pour suppression
            const hiddenField = document.getElementById('remove_main_image');
            if (hiddenField) {
                hiddenField.value = 'true';
                console.log('Champ marqué:', hiddenField.value);
            }
            
            // Masquer l'image principale
            const imgContainer = document.querySelector('.mb-3');
            const img = document.querySelector('img.img-thumbnail');
            if (imgContainer && imgContainer.querySelector('img')) {
                imgContainer.style.display = 'none';
                console.log('Container image masqué');
            } else if (img) {
                img.style.display = 'none';
                console.log('Image directe masquée');
            }
            
            // Masquer le bouton
            btn.style.display = 'none';
            
            // Afficher message
            const msg = document.createElement('div');
            msg.className = 'alert alert-success';
            msg.innerHTML = '✓ Image marquée pour suppression';
            btn.parentNode.appendChild(msg);
            
            console.log('=== SUPPRESSION TERMINÉE ===');
        };
    } else {
        console.log('=== BOUTON NON TROUVÉ ===');
    }
});

// Fonction de prévisualisation d'image
function previewMainImage(input) {
    console.log('=== PRÉVISUALISATION IMAGE ===');
    const preview = document.getElementById('main-image-preview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <div class="mt-3">
                    <img src="${e.target.result}" class="img-thumbnail" style="max-height: 200px;" alt="Nouvelle image">
                    <p class="text-success small">Nouvelle image sélectionnée</p>
                </div>
            `;
            console.log('Nouvelle image prévisualisée');
        };
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.innerHTML = '';
    }
}

// Fonction de base pour compatibilité
function updateLabelsDisplay() { console.log('updateLabelsDisplay appelée'); }
function updateZonesDisplay() { console.log('updateZonesDisplay appelée'); }
function updateHiddenFields() { console.log('updateHiddenFields appelée'); }
function setupEventListeners() { console.log('setupEventListeners appelée'); }

// Variables globales minimales
let labels = [];
let zones = [];
let selectedLabelIndex = -1;

// Initialisation DOMContentLoaded pour compatibilité
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded - Mode simplifié');
    
    // Charger les données depuis les variables générées côté serveur
    if (typeof existingLabels !== 'undefined') {
        labels = existingLabels;
    }
    if (typeof existingZones !== 'undefined') {
        zones = existingZones;
    }
    
    console.log('[IMAGE_LABELING_EDIT] Étiquettes chargées:', labels);
    console.log('[IMAGE_LABELING_EDIT] Zones chargées:', zones);
    
    // Initialiser l'interface interactive
    // Pas besoin d'appeler initializeLabelsInterface() car updateLabelsDisplay() fait déjà ce travail
    // Initialiser l'interface
    updateLabelsDisplay();
    updateZonesDisplay();
    updateHiddenFields();
    
    // Ajouter les événements
    setupEventListeners();
});

// Fonction directe pour ajouter une étiquette (appelée par onclick)
function addNewLabel() {
    console.log('[IMAGE_LABELING_EDIT] Fonction addNewLabel appelée');
    const labelText = prompt('Entrez le nom de l\'étiquette :');
    if (labelText && labelText.trim()) {
        labels.push(labelText.trim());
        updateLabelsDisplay();
        updateHiddenFields();
        console.log('[IMAGE_LABELING_EDIT] Étiquette ajoutée:', labelText);
    }
}

// Configuration des événements
function setupEventListeners() {
    // Code V3 supprimé pour éviter les conflits
    
    // Clic sur l'image pour placer des zones
    const mainImage = document.getElementById('main-image');
    if (mainImage) {
        mainImage.addEventListener('click', function(e) {
            if (selectedLabelIndex === -1) {
                alert('Veuillez d\'abord sélectionner une étiquette à placer.');
                return;
            }
            
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Stocker l'étiquette sélectionnée avant de réinitialiser l'index
            const selectedLabel = labels[selectedLabelIndex];
            
            // Ajouter la zone
            zones.push({
                x: Math.round(x),
                y: Math.round(y),
                label: selectedLabel
            });
            
            updateZonesDisplay();
            updateHiddenFields();
            selectedLabelIndex = -1; // Désélectionner
            updateLabelsDisplay(); // Rafraîchir l'affichage
            
            console.log('[IMAGE_LABELING_EDIT] Zone ajoutée:', { x: Math.round(x), y: Math.round(y), label: selectedLabel });
        });
    }
}

// Mise à jour de l'affichage des étiquettes
function updateLabelsDisplay() {
    const container = document.getElementById('labels-list');
    container.innerHTML = '';
    
    labels.forEach((label, index) => {
        const labelDiv = document.createElement('div');
        labelDiv.className = `badge me-2 mb-2 p-2 ${selectedLabelIndex === index ? 'bg-primary' : 'bg-secondary'}`;
        labelDiv.style.cursor = 'pointer';
        labelDiv.innerHTML = `
            ${label}
            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7em;" onclick="removeLabel(${index})"></button>
        `;
        
        // Clic pour sélectionner l'étiquette
        labelDiv.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-close')) return; // Éviter la sélection lors de la suppression
            
            selectedLabelIndex = selectedLabelIndex === index ? -1 : index;
            updateLabelsDisplay();
            console.log('[IMAGE_LABELING_EDIT] Étiquette sélectionnée:', selectedLabelIndex);
        });
        
        container.appendChild(labelDiv);
    });
}

// Suppression d'étiquette
function removeLabel(index) {
    // Stocker l'étiquette avant de la supprimer pour pouvoir filtrer les zones
    const labelToRemove = labels[index];
    
    // Supprimer l'étiquette
    labels.splice(index, 1);
    
    // Supprimer aussi les zones associées à cette étiquette
    zones = zones.filter(zone => zone.label !== labelToRemove);
    
    // Si l'étiquette supprimée était sélectionnée, désélectionner
    if (selectedLabelIndex === index) {
        selectedLabelIndex = -1;
    } else if (selectedLabelIndex > index) {
        // Ajuster l'index de sélection si une étiquette précédente a été supprimée
        selectedLabelIndex--;
    }
    
    updateLabelsDisplay();
    updateZonesDisplay();
    updateHiddenFields();
    console.log('[IMAGE_LABELING_EDIT] Étiquette supprimée:', labelToRemove);
}

// Mise à jour de l'affichage des zones
function updateZonesDisplay() {
    const overlay = document.getElementById('zones-overlay');
    const listDisplay = document.getElementById('zones-list-display');
    
    if (overlay) {
        overlay.innerHTML = '';
        
        zones.forEach((zone, index) => {
            // Marqueur visuel sur l'image
            const marker = document.createElement('div');
            marker.style.cssText = `
                position: absolute;
                left: ${zone.x}px;
                top: ${zone.y}px;
                width: 20px;
                height: 20px;
                background-color: #dc3545;
                border: 2px solid white;
                border-radius: 50%;
                cursor: pointer;
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 10px;
                font-weight: bold;
            `;
            marker.textContent = index + 1;
            marker.title = `${zone.label} - Cliquez pour supprimer`;
            marker.addEventListener('click', function() {
                removeZone(index);
            });
            
            overlay.appendChild(marker);
        });
    }
    
    // Liste des zones
    if (listDisplay) {
        listDisplay.innerHTML = '';
        
        if (zones.length === 0) {
            listDisplay.innerHTML = '<p class="text-muted">Aucune zone définie</p>';
        } else {
            zones.forEach((zone, index) => {
                const zoneDiv = document.createElement('div');
                zoneDiv.className = 'badge bg-info me-2 mb-2';
                zoneDiv.innerHTML = `
                    ${zone.label} (${zone.x}, ${zone.y})
                    <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7em;" onclick="removeZone(${index})"></button>
                `;
                listDisplay.appendChild(zoneDiv);
            });
        }
    }
}

// Suppression d'une zone
function removeZone(index) {
    zones.splice(index, 1);
    updateZonesDisplay();
    updateHiddenFields();
    console.log('[IMAGE_LABELING_EDIT] Zone supprimée:', index);
}

// Mise à jour des champs cachés pour la soumission
function updateHiddenFields() {
    const container = document.getElementById('hidden-fields');
    container.innerHTML = '';
    
    // Étiquettes
    labels.forEach(label => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'image_labels[]';
        input.value = label;
        container.appendChild(input);
    });
    
    // Zones
    zones.forEach(zone => {
        const inputX = document.createElement('input');
        inputX.type = 'hidden';
        inputX.name = 'zone_x[]';
        inputX.value = zone.x;
        container.appendChild(inputX);
        
        const inputY = document.createElement('input');
        inputY.type = 'hidden';
        inputY.name = 'zone_y[]';
        inputY.value = zone.y;
        container.appendChild(inputY);
        
        const inputLabel = document.createElement('input');
        inputLabel.type = 'hidden';
        inputLabel.name = 'zone_label[]';
        inputLabel.value = zone.label;
        container.appendChild(inputLabel);
    });
    
    console.log('[IMAGE_LABELING_EDIT] Champs cachés mis à jour - Étiquettes:', labels.length, 'Zones:', zones.length);
}

// Prévisualisation image d'exercice (fonction existante conservée)
function previewImage(input) {
    const preview = document.getElementById('image-preview');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="img-thumbnail mt-2" style="max-height: 150px;">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Fonction de prévisualisation image principale
function previewMainImage(input) {
    const preview = document.getElementById('main-image-preview');
    const mainImage = document.getElementById('main-image');
    const statusDiv = document.getElementById('image-upload-status');
    
    // Réinitialiser le statut
    if (statusDiv) {
        statusDiv.textContent = '';
    }
    
    // Masquer l'image actuelle si une nouvelle est sélectionnée
    const currentImageContainer = document.getElementById('current-image-container');
    if (currentImageContainer && input.files && input.files[0]) {
        currentImageContainer.style.opacity = '0.5';
        const noticeDiv = document.createElement('div');
        noticeDiv.className = 'alert alert-info mt-2';
        noticeDiv.innerHTML = '<i class="fas fa-info-circle"></i> L\'image actuelle sera remplacée après sauvegarde';
        currentImageContainer.appendChild(noticeDiv);
    }
    
    if (input.files && input.files[0]) {
        // Vérifier la taille du fichier (max 5MB)
        if (input.files[0].size > 5 * 1024 * 1024) {
            if (preview) {
                preview.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> L'image est trop volumineuse (max: 5MB).
                        Veuillez choisir une image plus petite.
                    </div>
                `;
            }
            if (statusDiv) {
                statusDiv.textContent = 'Erreur: L\'image est trop volumineuse (max 5MB)';
                statusDiv.className = 'form-text text-danger mt-2';
            }
            input.value = ''; // Réinitialiser l'input
            return;
        }
        
        // Vérifier le type de fichier
        const fileType = input.files[0].type;
        if (!['image/jpeg', 'image/jpg', 'image/png', 'image/gif'].includes(fileType)) {
            if (preview) {
                preview.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Format d'image non supporté.
                        Utilisez JPG, PNG ou GIF.
                    </div>
                `;
            }
            if (statusDiv) {
                statusDiv.textContent = 'Erreur: Format d\'image non supporté (jpg, png, gif uniquement)';
                statusDiv.className = 'form-text text-danger mt-2';
            }
            input.value = ''; // Réinitialiser l'input
            return;
        }
        
        // Si le bouton de suppression existe, réinitialiser son état
        const removeMainImageInput = document.getElementById('remove_main_image');
        if (removeMainImageInput) {
            removeMainImageInput.value = 'false';
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            if (preview) {
                preview.innerHTML = `
                    <div class="border rounded p-3" style="background-color: #f8f9fa;">
                        <p class="text-success small mb-2"><i class="fas fa-check-circle"></i> Nouvelle image sélectionnée :</p>
                        <img src="${e.target.result}" class="img-thumbnail" style="max-height: 200px; max-width: 300px;">
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <p class="text-muted small mb-0">Cette image sera enregistrée après sauvegarde</p>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelMainImageUpload()">Annuler</button>
                        </div>
                    </div>
                `;
            }
            if (statusDiv) {
                statusDiv.textContent = 'Image prête à être téléversée';
                statusDiv.className = 'form-text text-success mt-2';
            }
            
            // Mettre à jour aussi l'image interactive si elle existe
            if (mainImage) {
                mainImage.src = e.target.result;
            }
        };
        reader.readAsDataURL(input.files[0]);
    } else {
        if (preview) {
            preview.innerHTML = '';
        }
        
        // Restaurer l'affichage de l'image actuelle
        if (currentImageContainer) {
            currentImageContainer.style.opacity = '1';
            const noticeDiv = currentImageContainer.querySelector('.alert');
            if (noticeDiv) {
                noticeDiv.remove();
            }
        }
    }
}

// Fonction pour annuler l'upload d'image principale
function cancelMainImageUpload() {
    const input = document.getElementById('main_image');
    if (input) {
        input.value = '';
    }
    const preview = document.getElementById('main-image-preview');
    if (preview) {
        preview.innerHTML = '';
    }
    
    // Restaurer l'affichage de l'image actuelle
    const currentImageContainer = document.getElementById('current-image-container');
    if (currentImageContainer) {
        currentImageContainer.style.opacity = '1';
        const noticeDiv = currentImageContainer.querySelector('.alert');
        if (noticeDiv) {
            noticeDiv.remove();
        }
    }
}
</script>
{% endblock %}
