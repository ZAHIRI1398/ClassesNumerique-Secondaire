{% extends "base.html" %}

{% block title %}{{ exercise.title }}{% endblock %}

{% block head %}
<style>
    /* Couleurs personnalisées pour Flashcards */
    .flashcards-container {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        min-height: 100vh;
        padding: 20px 15px;
    }
    
    .flashcards-header {
        background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        border: none;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 176, 155, 0.3);
        color: white;
        margin-bottom: 20px;
    }
    
    .flashcards-header h3 {
        color: white !important;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .flashcards-header p {
        color: white !important;
        opacity: 0.95;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .progress-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        background: linear-gradient(145deg, #ffffff 0%, #f0fff4 100%);
    }
    
    .flashcard-main {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(86, 171, 47, 0.3);
        transition: all 0.3s ease;
    }
    
    .flashcard-main:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 50px rgba(86, 171, 47, 0.4);
    }
    
    .flashcard-content {
        color: white;
        padding: 40px;
    }
    
    .question-text {
        font-size: 1.4rem;
        font-weight: 600;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .answer-input {
        border: none;
        border-radius: 25px;
        padding: 15px 25px;
        font-size: 1.1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.95);
    }
    
    .answer-input:focus {
        box-shadow: 0 6px 20px rgba(86, 171, 47, 0.3);
        transform: translateY(-2px);
        outline: none;
    }
    
    .verify-btn {
        background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        font-weight: 600;
        color: white;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        transition: all 0.3s ease;
    }
    
    .verify-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        color: white;
    }
    
    .next-btn {
        background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        font-weight: 600;
        color: white;
        box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        transition: all 0.3s ease;
    }
    
    .next-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        color: white;
    }
    
    .progress-bar {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        border-radius: 10px;
    }
    
    .score-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 8px 15px;
        font-weight: 600;
    }
    
    .card-counter {
        color: #2d5016;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="flashcards-container">
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- En-tête de l'exercice -->
            <div class="card mb-4 flashcards-header">
                <div class="card-header border-0 text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>
                        {{ exercise.title }}
                    </h3>
                    <p class="mb-0 mt-2 opacity-90">{{ exercise.description }}</p>
                </div>
            </div>

            <!-- Barre de progression -->
            <div class="card mb-4 progress-card">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="card-counter">Progression</span>
                        <span id="card-counter" class="card-counter">1 / {{ content.cards|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="card-counter">Score actuel</span>
                        <span id="current-score" class="badge score-badge">0 / 0 (0%)</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar" id="progress-bar" role="progressbar" 
                             style="width: {{ (1 / content.cards|length * 100)|round }}%"></div>
                    </div>
                </div>
            </div>

            <!-- Carte Flashcard -->
            <div class="card shadow-lg flashcard-main" id="flashcard-container">
                <div class="card-body text-center flashcard-content">
                    <!-- Image de la carte -->
                    <div id="card-image-container" class="mb-4">
                        {% if content.cards[0].image %}
                        <img src="{{ url_for('static', filename=content.cards[0].image.replace('static/', '')) }}" 
                             alt="Image de la carte" class="img-fluid rounded" 
                             style="max-height: 300px;" id="card-image">
                        {% endif %}
                    </div>

                    <!-- Question -->
                    <h4 class="card-title mb-4 question-text" id="card-question">
                        {{ content.cards[0].question }}
                    </h4>

                    <!-- Zone de réponse -->
                    <div class="mb-4">
                        <input type="text" class="form-control answer-input text-center" 
                               id="user-answer" placeholder="Votre réponse..." autocomplete="off">
                    </div>

                    <!-- Boutons d'action -->
                    <div class="mb-3">
                        <button class="btn verify-btn me-3" id="verify-btn" onclick="verifyAnswer()">
                            <i class="fas fa-check me-2"></i>Vérifier
                        </button>
                        <button class="btn next-btn" id="next-btn" onclick="nextCard()" style="display: none;">
                            <i class="fas fa-arrow-right me-2"></i>Suivant
                        </button>
                    </div>

                    <!-- Feedback -->
                    <div id="feedback" class="alert" style="display: none;"></div>
                </div>
            </div>

            <!-- Bouton de fin -->
            <div class="text-center mt-4" id="finish-section" style="display: none;">
                <button class="btn verify-btn" onclick="finishExercise()">
                    <i class="fas fa-flag-checkered me-2"></i>Terminer l'exercice
                </button>
            </div>
        </div>
    </div>
</div>
</div>

<script>
// Données des cartes
const cards = {{ content.cards|tojson|safe }};
let currentCardIndex = 0;
let correctAnswers = 0;
let userAnswers = [];

// Éléments DOM
const cardImage = document.getElementById('card-image');
const cardImageContainer = document.getElementById('card-image-container');
const cardQuestion = document.getElementById('card-question');
const userAnswerInput = document.getElementById('user-answer');
const verifyBtn = document.getElementById('verify-btn');
const nextBtn = document.getElementById('next-btn');
const feedback = document.getElementById('feedback');
const cardCounter = document.getElementById('card-counter');
const progressBar = document.getElementById('progress-bar');
const currentScore = document.getElementById('current-score');
const finishSection = document.getElementById('finish-section');

function updateCard() {
    const card = cards[currentCardIndex];
    
    // Mettre à jour la question
    cardQuestion.textContent = card.question;
    
    // Mettre à jour l'image
    if (card.image) {
        cardImage.src = `/static/${card.image.replace('static/', '')}`;
        cardImageContainer.style.display = 'block';
    } else {
        cardImageContainer.style.display = 'none';
    }
    
    // Mettre à jour le compteur et la progression
    cardCounter.textContent = `${currentCardIndex + 1} / ${cards.length}`;
    const progressPercent = ((currentCardIndex + 1) / cards.length) * 100;
    progressBar.style.width = `${progressPercent}%`;
    
    // Mettre à jour le score
    updateScore();
}

function updateScore() {
    const totalAnswered = userAnswers.length;
    const scorePercent = totalAnswered > 0 ? Math.round((correctAnswers / totalAnswered) * 100) : 0;
    currentScore.textContent = `${correctAnswers} / ${totalAnswered} (${scorePercent}%)`;
    
    // Changer la couleur du badge selon le score
    currentScore.className = 'badge ' + (scorePercent >= 70 ? 'bg-success' : scorePercent >= 50 ? 'bg-warning' : 'bg-danger');
}

function verifyAnswer() {
    const userAnswer = userAnswerInput.value.trim().toLowerCase();
    const correctAnswer = cards[currentCardIndex].answer.toLowerCase();
    
    // Enregistrer la réponse
    userAnswers.push({
        cardIndex: currentCardIndex,
        userAnswer: userAnswerInput.value.trim(),
        correctAnswer: cards[currentCardIndex].answer,
        isCorrect: userAnswer === correctAnswer
    });
    
    // Afficher le feedback
    if (userAnswer === correctAnswer) {
        feedback.textContent = '✅ Correct ! Bien joué !';
        feedback.className = 'alert alert-success';
        correctAnswers++;
    } else {
        feedback.textContent = `❌ Incorrect. La bonne réponse était : ${cards[currentCardIndex].answer}`;
        feedback.className = 'alert alert-danger';
    }
    
    feedback.style.display = 'block';
    userAnswerInput.disabled = true;
    verifyBtn.style.display = 'none';
    
    // Mettre à jour le score immédiatement après la réponse
    updateScore();
    
    // Afficher le bouton suivant ou terminer
    if (currentCardIndex < cards.length - 1) {
        nextBtn.style.display = 'inline-block';
        nextBtn.focus();
    } else {
        finishSection.style.display = 'block';
    }
}

function nextCard() {
    currentCardIndex++;
    
    // Réinitialiser l'interface
    userAnswerInput.value = '';
    userAnswerInput.disabled = false;
    feedback.style.display = 'none';
    verifyBtn.style.display = 'inline-block';
    nextBtn.style.display = 'none';
    
    // Mettre à jour la carte
    updateCard();
    userAnswerInput.focus();
}

function finishExercise() {
    // Calculer le score
    const score = Math.round((correctAnswers / cards.length) * 100);
    
    // Créer un formulaire pour envoyer les données
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("handle_exercise_answer", exercise_id=exercise.id) }}';
    
    // Ajouter le token CSRF
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{ csrf_token() }}';
    form.appendChild(csrfInput);
    
    // Ajouter l'ID de l'exercice
    const exerciseIdInput = document.createElement('input');
    exerciseIdInput.type = 'hidden';
    exerciseIdInput.name = 'exercise_id';
    exerciseIdInput.value = '{{ exercise.id }}';
    form.appendChild(exerciseIdInput);
    
    // Ajouter les réponses
    const answersInput = document.createElement('input');
    answersInput.type = 'hidden';
    answersInput.name = 'answers';
    answersInput.value = JSON.stringify(userAnswers);
    form.appendChild(answersInput);
    
    // Ajouter le score final (attendu par le backend)
    const finalScoreInput = document.createElement('input');
    finalScoreInput.type = 'hidden';
    finalScoreInput.name = 'final_score';
    finalScoreInput.value = score;
    form.appendChild(finalScoreInput);
    
    // Ajouter le nombre de bonnes réponses
    const correctAnswersInput = document.createElement('input');
    correctAnswersInput.type = 'hidden';
    correctAnswersInput.name = 'correct_answers';
    correctAnswersInput.value = correctAnswers;
    form.appendChild(correctAnswersInput);
    
    // Ajouter le nombre total de réponses
    const totalAnswersInput = document.createElement('input');
    totalAnswersInput.type = 'hidden';
    totalAnswersInput.name = 'total_answers';
    totalAnswersInput.value = userAnswers.length;
    form.appendChild(totalAnswersInput);
    
    // Ajouter les réponses individuelles pour chaque carte
    userAnswers.forEach((answer, index) => {
        // Réponse de l'utilisateur pour cette carte
        const cardAnswerInput = document.createElement('input');
        cardAnswerInput.type = 'hidden';
        cardAnswerInput.name = `card_${index}_answer`;
        cardAnswerInput.value = answer.answer;
        form.appendChild(cardAnswerInput);
        
        // Si la réponse était correcte
        const cardCorrectInput = document.createElement('input');
        cardCorrectInput.type = 'hidden';
        cardCorrectInput.name = `card_${index}_correct`;
        cardCorrectInput.value = answer.correct;
        form.appendChild(cardCorrectInput);
    });
    
    // Ajouter le type d'exercice
    const typeInput = document.createElement('input');
    typeInput.type = 'hidden';
    typeInput.name = 'exercise_type';
    typeInput.value = 'flashcards';
    form.appendChild(typeInput);
    
    // Soumettre le formulaire
    document.body.appendChild(form);
    form.submit();
}

// Navigation au clavier
userAnswerInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        if (verifyBtn.style.display !== 'none') {
            verifyAnswer();
        } else if (nextBtn.style.display !== 'none') {
            nextCard();
        }
    }
});

// Initialiser la première carte
updateCard();
userAnswerInput.focus();
</script>
{% endblock %}
