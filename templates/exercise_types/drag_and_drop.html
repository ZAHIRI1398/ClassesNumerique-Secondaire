{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2>{{ exercise.title }}</h2>
            <p class="lead">{{ exercise.description }}</p>
        </div>
        {% if current_user.is_teacher %}
        <div class="btn-group">
            <a href="{{ url_for('edit_exercise', exercise_id=exercise.id) }}" class="btn btn-outline-primary">
                <i class="fas fa-edit"></i> Modifier
            </a>
            <form method="POST" action="{{ url_for('exercise.delete_exercise', exercise_id=exercise.id) }}" class="d-inline" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cet exercice ?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-outline-danger">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </form>
        </div>
        {% endif %}
    </div>

    <form method="POST" action="{{ url_for('handle_exercise_answer', exercise_id=exercise.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        {% if course %}
        <input type="hidden" name="course_id" value="{{ course.id }}"/>
        {% endif %}
        
        <!-- Champs cachés pour les réponses -->
        {% for i in range(content.draggable_items|length) %}
        <input type="hidden" name="answer_{{ i }}" id="answer_{{ i }}" value="">
        {% endfor %}
        
        <div class="alert alert-info mb-4">
            <i class="fas fa-info-circle"></i> <strong>Instructions :</strong> 
            Cliquez sur un élément à gauche, puis cliquez sur la zone de dépôt correspondante à droite. 
            Chaque élément a un numéro (0, 1, 2, 3...) qui correspond à sa position.
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <h4>Éléments à placer</h4>
                <div id="draggable-items" style="min-height: 200px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    {% for item in content.draggable_items %}
                        <div class="draggable-item" data-index="{{ loop.index0 }}" style="background: white; margin: 5px; padding: 10px; border-radius: 5px; cursor: pointer; border: 2px solid #007bff; position: relative;">
                            <span class="badge bg-primary" style="position: absolute; top: -8px; left: -8px; font-size: 12px;">{{ loop.index0 }}</span>
                            {{ item }}
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="col-md-6">
                <h4>Zones de dépôt</h4>
                {% for i in range(content.draggable_items|length) %}
                    <div class="drop-zone" data-position="{{ i }}" style="min-height: 60px; margin: 5px; padding: 15px; border: 2px dashed #28a745; border-radius: 5px; background: #f8fff9; position: relative;">
                        <span class="badge bg-success" style="position: absolute; top: -8px; left: -8px; font-size: 12px;">{{ i }}</span>
                        <span class="placeholder">Zone {{ i + 1 }} - Placez l'élément {{ i }} ici</span>
                        <div class="dropped-item" style="display: none;"></div>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-check"></i> Valider mes réponses
        </button>
        
        <!-- BOUTON DE TEST SANS JAVASCRIPT -->
        <button type="submit" class="btn btn-warning" style="margin-left: 10px;" onclick="document.getElementById('answer_0').value='1'; document.getElementById('answer_1').value='2'; document.getElementById('answer_2').value='3'; document.getElementById('answer_3').value='0'; console.log('Test button clicked'); return true;">
            <i class="fas fa-bug"></i> TEST SOUMISSION DIRECTE
        </button>
    </form>
</div>

<script>
let selectedItem = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('Template drag_and_drop_simple chargé');
    
    // Gestion des éléments glissables
    document.querySelectorAll('.draggable-item').forEach(item => {
        item.addEventListener('click', function() {
            // Désélectionner l'ancien élément
            if (selectedItem) {
                selectedItem.style.backgroundColor = 'white';
                selectedItem.style.border = '2px solid #ddd';
            }
            
            // Sélectionner le nouveau
            selectedItem = this;
            this.style.backgroundColor = '#007bff';
            this.style.border = '2px solid #0056b3';
            this.style.color = 'white';
            
            console.log('Élément sélectionné:', this.textContent.trim(), 'Index:', this.dataset.index);
        });
    });
    
    // Gestion des zones de dépôt
    document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.addEventListener('click', function() {
            if (!selectedItem) {
                alert('Veuillez d\'abord sélectionner un élément à placer.');
                return;
            }
            
            const position = this.dataset.position;
            const itemIndex = selectedItem.dataset.index;
            const itemText = selectedItem.textContent.trim();
            
            console.log('Placer élément', itemIndex, 'dans zone', position);
            
            // Mettre à jour l'affichage de la zone
            const placeholder = this.querySelector('.placeholder');
            const droppedItem = this.querySelector('.dropped-item');
            
            placeholder.style.display = 'none';
            droppedItem.style.display = 'block';
            droppedItem.textContent = itemText;
            droppedItem.style.background = '#28a745';
            droppedItem.style.color = 'white';
            droppedItem.style.padding = '5px';
            droppedItem.style.borderRadius = '3px';
            
            // Mettre à jour le champ caché
            const hiddenField = document.getElementById('answer_' + position);
            if (hiddenField) {
                hiddenField.value = itemIndex;
                console.log('Champ answer_' + position + ' mis à jour avec:', itemIndex);
            }
            
            // Cacher l'élément original
            selectedItem.style.display = 'none';
            selectedItem = null;
            
            // Afficher l'état actuel
            debugFormState();
        });
    });
    
    const totalItems = {{ content.draggable_items|length }};
    
    function debugFormState() {
        console.log('=== État des champs cachés ===');
        for (let i = 0; i < totalItems; i++) {
            const field = document.getElementById('answer_' + i);
            if (field) {
                console.log('answer_' + i + ':', field.value);
            }
        }
    }
    
    window.validateAndSubmit = function() {
        console.log('=== VALIDATION AVANT SOUMISSION ===');
        debugFormState();
        
        let allFilled = true;
        for (let i = 0; i < totalItems; i++) {
            const field = document.getElementById('answer_' + i);
            if (!field || field.value === '') {
                allFilled = false;
                console.warn('Champ answer_' + i + ' vide');
            }
        }
        
        if (!allFilled) {
            alert('Veuillez placer tous les éléments dans les zones de dépôt.');
            return false;
        }
        
        console.log('Validation OK - Soumission du formulaire');
        return true;
    };
    
    // État initial
    debugFormState();
});
</script>
{% endblock %}
