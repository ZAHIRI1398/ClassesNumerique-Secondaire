{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>{% if exercise %}Modifier{% else %}Créer{% endif %} un exercice de mots mêlés</h2>

    <form method="POST" class="mt-4">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="mb-3">
            <label for="title" class="form-label">Titre</label>
            <input type="text" class="form-control" id="title" name="title" value="{{ exercise.title if exercise else '' }}" required>
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3" required>{{ exercise.description if exercise else '' }}</textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Mots à trouver</label>
            <div id="words-container">
                {% if content and content.words %}
                    {% for word in content.words %}
                        <div class="input-group mb-2 word-input">
                            <input type="text" class="form-control" name="words[]" value="{{ word }}" required>
                            <button type="button" class="btn btn-outline-danger remove-word">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="input-group mb-2 word-input">
                        <input type="text" class="form-control" name="words[]" required>
                        <button type="button" class="btn btn-outline-danger remove-word">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                {% endif %}
            </div>
            <button type="button" class="btn btn-outline-primary" id="add-word">
                <i class="fas fa-plus"></i> Ajouter un mot
            </button>
        </div>

        <div class="mb-3">
            <label for="grid-size" class="form-label">Taille de la grille</label>
            <select class="form-select" id="grid-size" name="grid_size" required>
                {% for size in range(8, 21) %}
                    <option value="{{ size }}" {% if content and content.grid and content.grid|length == size %}selected{% endif %}>
                        {{ size }}x{{ size }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="difficulty" class="form-label">Difficulté</label>
            <select class="form-select" id="difficulty" name="difficulty" required>
                <option value="easy" {% if exercise and exercise.difficulty == 'easy' %}selected{% endif %}>Facile</option>
                <option value="medium" {% if exercise and exercise.difficulty == 'medium' %}selected{% endif %}>Moyen</option>
                <option value="hard" {% if exercise and exercise.difficulty == 'hard' %}selected{% endif %}>Difficile</option>
            </select>
        </div>

        {% if courses %}
        <div class="mb-3">
            <label for="course" class="form-label">Cours</label>
            <select class="form-select" id="course" name="course_id">
                <option value="">Aucun cours</option>
                {% for course in courses %}
                    <option value="{{ course.id }}" {% if exercise and exercise.course_id == course.id %}selected{% endif %}>
                        {{ course.title }}
                    </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Enregistrer
        </button>
        <a href="{{ url_for('exercise.exercise_library') }}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Annuler
        </a>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing word search editor'); // Debug
    const container = document.getElementById('words-container');
    const addButton = document.getElementById('add-word');
    
    console.log('Container:', container); // Debug
    console.log('Add button:', addButton); // Debug

    function createWordInput() {
        const div = document.createElement('div');
        div.className = 'input-group mb-2 word-input';
        div.innerHTML = `
            <input type="text" class="form-control" name="words[]" required placeholder="Entrez un mot">
            <button type="button" class="btn btn-outline-danger remove-word">
                <i class="fas fa-times"></i>
            </button>
        `;
        return div;
    }

    if (addButton && container) {
        addButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Add button clicked successfully!'); // Debug
            const newInput = createWordInput();
            container.appendChild(newInput);
            console.log('New input added successfully!'); // Debug
            
            // Focus sur le nouveau champ
            const newInputField = newInput.querySelector('input');
            if (newInputField) {
                newInputField.focus();
            }
        });
        
        // Alternative: ajouter aussi un écouteur direct
        addButton.onclick = function(e) {
            e.preventDefault();
            console.log('Alternative onclick triggered'); // Debug
            const newInput = createWordInput();
            container.appendChild(newInput);
        };
    } else {
        console.error('Elements not found - Container:', container, 'Button:', addButton);
    }

    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-word') || e.target.closest('.remove-word')) {
            const wordInput = e.target.closest('.word-input');
            if (container.children.length > 1) {
                wordInput.remove();
            }
        }
    });
});
</script>
{% endblock %}
