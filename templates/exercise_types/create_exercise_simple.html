{% extends "base.html" %}

{% block title %}Créer un exercice{% endblock title %}

{% block content %}
<div class="container py-4">
    <h1>Créer un nouvel exercice</h1>
    <form method="post" action="{{ url_for('create_exercise') }}" enctype="multipart/form-data">
        {{ form.csrf_token }}
        
        <!-- Sélection du cours -->
        <div class="mb-3">
            <label for="course_id" class="form-label">Sélectionner un cours</label>
            <select class="form-select" id="course_id" name="course_id">
                <option value="">-- Choisir un cours (optionnel) --</option>
                {% if current_user.is_teacher %}
                    {% for class_obj in current_user.classes_teaching %}
                        <optgroup label="{{ class_obj.name }}">
                            {% for course in class_obj.courses %}
                                <option value="{{ course.id }}">{{ course.title }}</option>
                            {% endfor %}
                        </optgroup>
                    {% endfor %}
                {% endif %}
            </select>
        </div>

        <!-- Matière -->
        <div class="mb-3">
            <label for="subject" class="form-label">Matière</label>
            <select class="form-select" id="subject" name="subject">
                <option value="">-- Sélectionner une matière --</option>
                <option value="Français">Français</option>
                <option value="Mathématiques">Mathématiques</option>
                <option value="Histoire">Histoire</option>
                <option value="Géographie">Géographie</option>
                <option value="Sciences">Sciences</option>
            </select>
        </div>

        <div class="mb-3">
            {{ form.exercise_type.label(class="form-label") }}
            {{ form.exercise_type(class="form-select", id="exercise_type", onchange="showExerciseType()") }}
        </div>

        <div class="mb-3">
            {{ form.title.label(class="form-label") }}
            {{ form.title(class="form-control") }}
        </div>

        <div class="mb-3">
            {{ form.description.label(class="form-label") }}
            {{ form.description(class="form-control", rows=3) }}
        </div>

        <!-- Section QCM -->
        <div id="qcm_section" class="exercise-type-section" style="display: none;">
            <h3>Questions à choix multiples</h3>
            <div id="questions_container"></div>
            <button type="button" class="btn btn-primary mb-3" onclick="addQuestion()">
                <i class="bi bi-plus-circle"></i> Ajouter une question
            </button>
        </div>

        <!-- Section Mots mêlés -->
        <div id="word_search_section" class="exercise-type-section" style="display: none;">
            <h3>Mots mêlés</h3>
            <div id="words_container">
                <div class="input-group mb-2">
                    <input type="text" name="word_search_words[]" class="form-control" placeholder="Entrez un mot (ou plusieurs mots séparés par des virgules)">
                </div>
            </div>
            <button type="button" class="btn btn-primary mb-3" onclick="addWord()">
                <i class="bi bi-plus-circle"></i> Ajouter un mot
            </button>
        </div>

        <!-- Section Texte à trous -->
        <div id="fill_in_blanks_section" class="exercise-type-section" style="display: none;">
            <h3>Texte à trous</h3>
            <p class="text-muted">Utilisez ___ (trois underscores) pour marquer les espaces à remplir.</p>
            
            <div id="fill_in_blanks_container">
                <div class="sentence-block mb-3">
                    <label class="form-label">Phrase 1</label>
                    <input type="text" class="form-control" name="fill_in_blanks_sentences[]" 
                           placeholder="Entrez une phrase avec des trous (ex: Le chat ___ sur le tapis)">
                </div>
            </div>
            
            <button type="button" class="btn btn-primary mb-3" onclick="addFillInBlanksSentence()">
                <i class="bi bi-plus-circle"></i> Ajouter une phrase
            </button>
            
            <h4 class="mt-4">Mots de réponse</h4>
            <p class="text-muted">Ajoutez les mots qui peuvent remplir les trous.</p>
            
            <div id="fill_in_blanks_words_container">
                <div class="input-group mb-2">
                    <input type="text" name="fill_in_blanks_words[]" class="form-control" placeholder="Entrez un mot de réponse">
                </div>
            </div>
            
            <button type="button" class="btn btn-primary mb-3" onclick="addFillInBlanksWord()">
                <i class="bi bi-plus-circle"></i> Ajouter un mot de réponse
            </button>
        </div>

        <!-- Section Mots mêlés -->
        <div id="word_search_section" class="exercise-type-section" style="display: none;">
            <h3>Mots mêlés</h3>
            <p class="text-muted">Ajoutez les mots qui seront cachés dans la grille de mots mêlés (5 mots maximum).</p>
            
            <div class="word-search-inputs" style="background: #f8f9fa; padding: 15px; border: 2px solid #28a745; border-radius: 8px; margin: 15px 0;">
                <h5 style="color: #28a745; margin-bottom: 15px;">Mots à cacher dans la grille :</h5>
                
                <div class="mb-3">
                    <label class="form-label">Mot 1 :</label>
                    <input type="text" name="word_search_words[]" class="form-control" placeholder="Entrez le premier mot" style="border: 2px solid #007bff;">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Mot 2 :</label>
                    <input type="text" name="word_search_words[]" class="form-control" placeholder="Entrez le deuxième mot" style="border: 2px solid #007bff;">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Mot 3 :</label>
                    <input type="text" name="word_search_words[]" class="form-control" placeholder="Entrez le troisième mot" style="border: 2px solid #007bff;">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Mot 4 (optionnel) :</label>
                    <input type="text" name="word_search_words[]" class="form-control" placeholder="Entrez le quatrième mot (optionnel)" style="border: 2px solid #6c757d;">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Mot 5 (optionnel) :</label>
                    <input type="text" name="word_search_words[]" class="form-control" placeholder="Entrez le cinquième mot (optionnel)" style="border: 2px solid #6c757d;">
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> <strong>Astuce :</strong> Vous pouvez laisser les champs optionnels vides. Au minimum 3 mots sont recommandés pour une grille intéressante.
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Taille de la grille</label>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Largeur</label>
                        <input type="number" name="grid_width" class="form-control" value="15" min="10" max="20">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Hauteur</label>
                        <input type="number" name="grid_height" class="form-control" value="15" min="10" max="20">
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Mots mêlés -->
        <div id="word_search_section" class="exercise-type-section" style="display: none;">
            <h3>Mots mêlés</h3>
            <p class="text-muted">Créez une grille de mots mêlés. Entrez les mots que les élèves devront trouver dans la grille.</p>
            
            <div class="mb-3">
                <label class="form-label">Mots à cacher dans la grille</label>
                <div id="word_search_words_container" style="border: 2px solid #28a745; padding: 15px; border-radius: 8px; background-color: #f8f9fa;">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> <strong>Instructions :</strong> 
                        Entrez vos mots dans les champs ci-dessous. Vous pouvez aussi séparer plusieurs mots par des virgules dans un seul champ.
                        <br><strong>Exemple :</strong> CHAT,CHIEN,OISEAU ou un mot par champ.
                    </div>
                    
                    <!-- 5 champs fixes pour les mots -->
                    <div class="mb-3">
                        <label class="form-label" style="color: #0066cc; font-weight: bold;">Mot 1 : (obligatoire)</label>
                        <input type="text" name="word_search_words[]" class="form-control" 
                               style="border: 2px solid #0066cc;" 
                               placeholder="Entrez le premier mot ou plusieurs mots séparés par des virgules" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label" style="color: #0066cc; font-weight: bold;">Mot 2 : (obligatoire)</label>
                        <input type="text" name="word_search_words[]" class="form-control" 
                               style="border: 2px solid #0066cc;" 
                               placeholder="Entrez le deuxième mot" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label" style="color: #0066cc; font-weight: bold;">Mot 3 : (obligatoire)</label>
                        <input type="text" name="word_search_words[]" class="form-control" 
                               style="border: 2px solid #0066cc;" 
                               placeholder="Entrez le troisième mot" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label" style="color: #666; font-weight: normal;">Mot 4 : (optionnel)</label>
                        <input type="text" name="word_search_words[]" class="form-control" 
                               style="border: 2px solid #ccc;" 
                               placeholder="Mot optionnel">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label" style="color: #666; font-weight: normal;">Mot 5 : (optionnel)</label>
                        <input type="text" name="word_search_words[]" class="form-control" 
                               style="border: 2px solid #ccc;" 
                               placeholder="Mot optionnel">
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Taille de la grille</label>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Largeur</label>
                        <input type="number" name="grid_width" class="form-control" value="15" min="10" max="20">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Hauteur</label>
                        <input type="number" name="grid_height" class="form-control" value="15" min="10" max="20">
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Association de paires -->
        <div id="pairs_section" class="exercise-type-section" style="display: none;">
            <h3>Association de paires</h3>
            <p class="text-muted">Créez des paires d'éléments à associer. Chaque élément peut être du texte ou une image.</p>
            
            <div id="pairs_container">
                <div class="pair-item mb-4 border p-3 rounded" data-pair-id="1">
                    <h5>Paire 1</h5>
                    <div class="row">
                        <!-- Élément de gauche -->
                        <div class="col-md-6">
                            <label class="form-label">Élément de gauche</label>
                            <div class="mb-2">
                                <select class="form-select pair-left-type" name="pair_left_type_1" onchange="togglePairInput(this, 'left')">
                                    <option value="text">Texte</option>
                                    <option value="image">Image</option>
                                </select>
                            </div>
                            <div class="pair-left-text">
                                <input type="text" class="form-control" name="pair_left_1" placeholder="Entrez le texte">
                            </div>
                            <div class="pair-left-image" style="display: none;">
                                <input type="file" class="form-control" name="pair_left_image_1" accept="image/*">
                            </div>
                        </div>
                        
                        <!-- Élément de droite -->
                        <div class="col-md-6">
                            <label class="form-label">Élément de droite</label>
                            <div class="mb-2">
                                <select class="form-select pair-right-type" name="pair_right_type_1" onchange="togglePairInput(this, 'right')">
                                    <option value="text">Texte</option>
                                    <option value="image">Image</option>
                                </select>
                            </div>
                            <div class="pair-right-text">
                                <input type="text" class="form-control" name="pair_right_1" placeholder="Entrez le texte">
                            </div>
                            <div class="pair-right-image" style="display: none;">
                                <input type="file" class="form-control" name="pair_right_image_1" accept="image/*">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn btn-primary mb-3" onclick="addPair()">
                <i class="bi bi-plus-circle"></i> Ajouter une paire
            </button>
        </div>

        <!-- Section Souligner les mots -->
        <div id="underline_words_section" class="exercise-type-section" style="display: none;">
            <h3>Souligner les mots</h3>
            <div id="underline_sentences_container">
                <div class="sentence-item mb-3">
                    <label class="form-label">Phrase 1</label>
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" class="form-control" name="underline_sentences[]" 
                                   placeholder="Entrez une phrase">
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" name="underline_words[]" 
                                   placeholder="Mots à souligner (séparés par des virgules)">
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn btn-primary mb-3" onclick="addUnderlineSentence()">
                <i class="bi bi-plus-circle"></i> Ajouter une phrase
            </button>
        </div>

        <!-- Section Dictée -->
        <div id="dictation_section" class="exercise-type-section" style="display: none;">
            <h3>Dictée</h3>
            <p class="text-muted">Écoute et écris sans faute. Ne mets pas de majuscule.</p>
            
            <div class="mb-3">
                <label class="form-label">Instructions personnalisées (optionnel)</label>
                <input type="text" class="form-control" name="dictation_instructions" 
                       placeholder="Écoute et écris sans faute. Ne mets pas de majuscule.">
            </div>
            
            <div id="dictation_sentences_container">
                <div class="dictation-item mb-4 p-3" style="border: 1px solid #ddd; border-radius: 8px; background-color: #f8f9fa;">
                    <h5>Phrase 1</h5>
                    <div class="row">
                        <div class="col-md-8">
                            <label class="form-label">Texte de la phrase</label>
                            <input type="text" class="form-control" name="dictation_sentences[]" 
                                   placeholder="Entrez la phrase à dicter" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fichier audio (optionnel)</label>
                            <input type="file" class="form-control" name="dictation_audio_0" 
                                   accept="audio/*" title="Uploadez un fichier audio MP3 ou WAV">
                            <small class="text-muted">Formats acceptés : MP3, WAV</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn btn-primary mb-3" onclick="addDictationSentence()">
                <i class="bi bi-plus-circle"></i> Ajouter une phrase
            </button>
        </div>

        <!-- Section Glisser-déposer -->
        <div id="drag_and_drop_section" class="exercise-type-section" style="display: none;">
            <h3>Glisser-déposer</h3>
            <p class="text-muted">Créez des éléments à faire glisser et des zones de dépôt.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <h4>Éléments à glisser</h4>
                    <div id="drag_items_container">
                        <div class="input-group mb-2">
                            <input type="text" name="drag_items[]" class="form-control" placeholder="Entrez un élément à glisser" required>
                            <button type="button" class="btn btn-danger" onclick="this.closest('.input-group').remove()">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addDragItem()">
                        <i class="bi bi-plus-circle"></i> Ajouter un élément
                    </button>
                </div>
                
                <div class="col-md-6">
                    <h4>Zones de dépôt</h4>
                    <div id="drop_zones_container">
                        <div class="input-group mb-2">
                            <input type="text" name="drop_zones[]" class="form-control" placeholder="Entrez une zone de dépôt" required>
                            <button type="button" class="btn btn-danger" onclick="this.closest('.input-group').remove()">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addDropZone()">
                        <i class="bi bi-plus-circle"></i> Ajouter une zone
                    </button>
                </div>
            </div>
            
            <div class="mt-4">
                <h4>Ordre correct</h4>
                <p class="text-muted">Spécifiez l'ordre correct des éléments (numérotation à partir de 0).</p>
                <div id="correct_order_container">
                    <input type="text" name="correct_order" class="form-control" placeholder="Ex: 1,0,2,3 (ordre des éléments dans les zones)" required>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-success btn-lg">Créer l'exercice</button>
            <button type="button" class="btn btn-primary btn-lg ms-3" onclick="testFormSubmission()">Test Submit</button>
            <button type="button" class="btn btn-warning btn-lg ms-3" onclick="directSubmit()">Submit Direct</button>
        </div>
    </form>
</div>

<script>
// Fonction pour afficher/masquer les sections selon le type d'exercice
function showExerciseType() {
    const exerciseType = document.getElementById('exercise_type').value;
    const sections = document.querySelectorAll('.exercise-type-section');
    
    sections.forEach(section => section.style.display = 'none');

    if (exerciseType) {
        const targetSection = document.getElementById(exerciseType + '_section');
        if (targetSection) {
            targetSection.style.display = 'block';
        }
    }
}

// Fonction pour ajouter une question QCM
function addQuestion() {
    const container = document.getElementById('questions_container');
    const questionCount = container.children.length;
    
    const questionDiv = document.createElement('div');
    questionDiv.className = 'card mb-3 p-3';
    questionDiv.innerHTML = `
        <div class="mb-3">
            <label class="form-label">Question ${questionCount + 1}</label>
            <input type="text" class="form-control" name="question_${questionCount}" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Options</label>
            <div style="background: yellow; padding: 5px; margin: 5px 0;">🔥 TEMPLATE SIMPLE CORRIGÉ - 3 OPTIONS AVEC RADIO 🔥</div>
            <div class="options-container">
                <div class="input-group mb-2">
                    <div class="input-group-text">
                        <input class="form-check-input" type="radio" name="correct_${questionCount}" value="0">
                    </div>
                    <input type="text" class="form-control" name="option_${questionCount}_0" placeholder="Option A" required>
                </div>
                <div class="input-group mb-2">
                    <div class="input-group-text">
                        <input class="form-check-input" type="radio" name="correct_${questionCount}" value="1">
                    </div>
                    <input type="text" class="form-control" name="option_${questionCount}_1" placeholder="Option B" required>
                </div>
                <div class="input-group mb-2">
                    <div class="input-group-text">
                        <input class="form-check-input" type="radio" name="correct_${questionCount}" value="2">
                    </div>
                    <input type="text" class="form-control" name="option_${questionCount}_2" placeholder="Option C" required>
                </div>
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addOption(this)">
                    <i class="fas fa-plus"></i> Ajouter une option
                </button>
            </div>
        </div>
        <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.card').remove()">
            Supprimer cette question
        </button>
    `;
    container.appendChild(questionDiv);
}

// Fonction pour ajouter un mot (Mots mêlés) - VERSION FINALE QUI FONCTIONNE
function addWord() {
    console.log('[DEBUG] addWord() appelée - VERSION FINALE');
    
    // Trouver ou créer un conteneur qui fonctionne (basé sur le test brutal réussi)
    let workingContainer = document.getElementById('final_word_container');
    
    if (!workingContainer) {
        console.log('[DEBUG] Création du conteneur final qui fonctionne');
        
        // Créer un conteneur avec l'approche qui fonctionne (position relative)
        workingContainer = document.createElement('div');
        workingContainer.id = 'final_word_container';
        workingContainer.style.cssText = `
            position: relative;
            display: block !important;
            min-height: 50px !important;
            height: auto !important;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid #28a745;
            border-radius: 8px;
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        `;
        
        // Ajouter un titre
        const title = document.createElement('h5');
        title.textContent = 'Mots à cacher dans la grille :';
        title.style.cssText = 'margin: 0 0 10px 0; color: #28a745; font-weight: bold;';
        workingContainer.appendChild(title);
        
        // L'insérer après le bouton "Ajouter un mot"
        const addButton = document.querySelector('button[onclick="addWord()"]');
        if (addButton) {
            addButton.parentNode.insertBefore(workingContainer, addButton.nextSibling);
        }
    }
    
    // Compter les mots existants (exclure le titre)
    const existingWords = workingContainer.querySelectorAll('div[data-word-item]').length;
    console.log('[DEBUG] Nombre de mots existants:', existingWords);
    
    // Créer le nouvel élément avec l'approche qui fonctionne
    const wordDiv = document.createElement('div');
    wordDiv.setAttribute('data-word-item', 'true');
    wordDiv.style.cssText = `
        display: flex !important;
        align-items: center;
        margin-bottom: 10px;
        min-height: 45px !important;
        height: auto !important;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px;
        background-color: white;
        position: relative;
    `;
    
    // Créer l'input avec l'approche qui fonctionne
    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'word_search_words[]';
    input.placeholder = `Entrez le mot ${existingWords + 1}`;
    input.style.cssText = `
        height: 35px !important;
        min-height: 35px !important;
        width: 250px;
        padding: 8px 12px;
        border: 2px solid #007bff;
        border-radius: 4px;
        margin-right: 10px;
        font-size: 14px;
        display: block !important;
    `;
    
    // Créer le bouton avec l'approche qui fonctionne
    const button = document.createElement('button');
    button.type = 'button';
    button.innerHTML = '❌ Supprimer';
    button.onclick = function() { 
        this.parentElement.remove();
        console.log('Mot supprimé');
    };
    button.style.cssText = `
        height: 35px !important;
        min-height: 35px !important;
        padding: 8px 15px;
        border: 2px solid #dc3545;
        background-color: #dc3545;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        display: block !important;
    `;
    
    // Assembler les éléments
    wordDiv.appendChild(input);
    wordDiv.appendChild(button);
    
    console.log('[DEBUG] Nouvel élément créé avec approche finale');
    
    // Ajouter au conteneur
    workingContainer.appendChild(wordDiv);
    
    // Vérification finale
    const newWordCount = workingContainer.querySelectorAll('div[data-word-item]').length;
    console.log('[DEBUG] Nombre de mots après ajout:', newWordCount);
    
    if (newWordCount > existingWords) {
        console.log('[SUCCESS] Mot ajouté avec succès!');
        console.log('[DEBUG] Hauteur du conteneur:', workingContainer.offsetHeight);
        console.log('[DEBUG] Hauteur du nouvel élément:', wordDiv.offsetHeight);
        
        // Focus sur le nouveau champ
        input.focus();
    } else {
        console.error('[ERROR] Échec de l\'ajout du mot!');
    }
}

// Fonction pour supprimer un mot (Mots mêlés)
function removeWord(button) {
    const container = document.getElementById('word_search_container');
    if (container.children.length > 1) {
        button.closest('.input-group').remove();
    }
}

// Fonction pour ajouter une phrase (Texte à trous)
function addFillInBlanksSentence() {
    const container = document.getElementById('fill_in_blanks_container');
    const sentenceCount = container.children.length;
    
    const sentenceDiv = document.createElement('div');
    sentenceDiv.className = 'sentence-block mb-3';
    sentenceDiv.innerHTML = `
        <label class="form-label">Phrase ${sentenceCount + 1}</label>
        <div class="input-group">
            <input type="text" class="form-control" name="fill_in_blanks_sentences[]" 
                   placeholder="Entrez une phrase avec des trous (ex: Le chat ___ sur le tapis)" required>
            <button type="button" class="btn btn-danger" onclick="this.closest('.sentence-block').remove(); updateFillInBlanksLabels()">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(sentenceDiv);
}

// Fonction pour ajouter un mot de réponse (Texte à trous)
function addFillInBlanksWord() {
    const container = document.getElementById('fill_in_blanks_words_container');
    const wordDiv = document.createElement('div');
    wordDiv.className = 'input-group mb-2';
    wordDiv.innerHTML = `
        <input type="text" name="fill_in_blanks_words[]" class="form-control" placeholder="Entrez un mot de réponse" required>
        <button type="button" class="btn btn-danger" onclick="this.closest('.input-group').remove()">
            <i class="bi bi-trash"></i>
        </button>
    `;
    container.appendChild(wordDiv);
}

// Fonction pour ajouter une phrase (Souligner les mots)
function addUnderlineSentence() {
    const container = document.getElementById('underline_sentences_container');
    const sentenceCount = container.children.length;
    
    const sentenceDiv = document.createElement('div');
    sentenceDiv.className = 'sentence-item mb-3';
    sentenceDiv.innerHTML = `
        <label class="form-label">Phrase ${sentenceCount + 1}</label>
        <div class="row">
            <div class="col-md-8">
                <input type="text" class="form-control" name="underline_sentences[]" 
                       placeholder="Entrez une phrase" required>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" name="underline_words[]" 
                       placeholder="Mots à souligner (séparés par des virgules)" required>
            </div>
        </div>
        <button type="button" class="btn btn-outline-danger btn-sm mt-2" onclick="this.closest('.sentence-item').remove(); updateUnderlineLabels()">
            <i class="bi bi-trash"></i> Supprimer cette phrase
        </button>
    `;
    container.appendChild(sentenceDiv);
}

// Fonction pour mettre à jour les labels des phrases (Texte à trous)
function updateFillInBlanksLabels() {
    const container = document.getElementById('fill_in_blanks_container');
    const sentences = container.querySelectorAll('.sentence-block');
    
    sentences.forEach((sentence, index) => {
        const label = sentence.querySelector('label');
        label.textContent = `Phrase ${index + 1}`;
    });
}

// Fonction pour mettre à jour les labels des phrases (Souligner les mots)
function updateUnderlineLabels() {
    const container = document.getElementById('underline_sentences_container');
    const sentences = container.querySelectorAll('.sentence-item');
    
    sentences.forEach((sentence, index) => {
        const label = sentence.querySelector('label');
        label.textContent = `Phrase ${index + 1}`;
    });
}

// Fonction pour ajouter une option dynamiquement (QCM)
function addOption(button) {
    const questionCard = button.closest('.card');
    const optionsContainer = questionCard.querySelector('.options-container');
    const questionIndex = Array.from(document.getElementById('questions_container').children).indexOf(questionCard);
    
    // Compter le nombre d'options existantes
    const existingOptions = optionsContainer.querySelectorAll('.input-group');
    const optionIndex = existingOptions.length;
    
    // Générer la lettre de l'option (A, B, C, D, E, F...)
    const optionLetter = String.fromCharCode(65 + optionIndex); // A=65, B=66, etc.
    
    // Créer la nouvelle option
    const newOptionDiv = document.createElement('div');
    newOptionDiv.className = 'input-group mb-2';
    newOptionDiv.innerHTML = `
        <div class="input-group-text">
            <input class="form-check-input" type="radio" name="correct_${questionIndex}" value="${optionIndex}">
        </div>
        <input type="text" class="form-control" name="option_${questionIndex}_${optionIndex}" placeholder="Option ${optionLetter}" required>
        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeOption(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Ajouter la nouvelle option avant le bouton "Ajouter une option"
    optionsContainer.appendChild(newOptionDiv);
    
    console.log(`Option ${optionLetter} ajoutée à la question ${questionIndex + 1}`);
}

// Fonction pour supprimer une option (QCM)
function removeOption(button) {
    const optionDiv = button.closest('.input-group');
    const questionCard = button.closest('.card');
    const optionsContainer = questionCard.querySelector('.options-container');
    
    // Vérifier qu'il reste au moins 2 options
    const remainingOptions = optionsContainer.querySelectorAll('.input-group');
    if (remainingOptions.length <= 2) {
        alert('Une question doit avoir au moins 2 options.');
        return;
    }
    
    // Supprimer l'option
    optionDiv.remove();
    
    // Mettre à jour les indices et placeholders des options restantes
    updateOptionIndices(questionCard);
}

// Fonction pour mettre à jour les indices des options après suppression
function updateOptionIndices(questionCard) {
    const optionsContainer = questionCard.querySelector('.options-container');
    const options = optionsContainer.querySelectorAll('.input-group');
    const questionIndex = Array.from(document.getElementById('questions_container').children).indexOf(questionCard);
    
    options.forEach((option, index) => {
        const radio = option.querySelector('input[type="radio"]');
        const textInput = option.querySelector('input[type="text"]');
        const optionLetter = String.fromCharCode(65 + index); // A, B, C, D...
        
        // Mettre à jour les attributs
        radio.value = index;
        textInput.name = `option_${questionIndex}_${index}`;
        textInput.placeholder = `Option ${optionLetter}`;
    });
}

// Fonction de test pour diagnostiquer la soumission du formulaire
function testFormSubmission() {
    console.log('=== TEST FORM SUBMISSION ===');
    
    const form = document.querySelector('form');
    const exerciseType = document.getElementById('exercise_type').value;
    const title = document.querySelector('input[name="title"]').value;
    
    console.log('Form element:', form);
    console.log('Exercise type:', exerciseType);
    console.log('Title:', title);
    console.log('Form action:', form.action);
    console.log('Form method:', form.method);
    
    // Test de validation basique
    if (!exerciseType) {
        alert('ERREUR: Aucun type d\'exercice sélectionné!');
        return;
    }
    
    if (!title) {
        alert('ERREUR: Aucun titre saisi!');
        return;
    }
    
    console.log('Validation OK - Tentative de soumission...');
    alert('Test OK! Le formulaire semble valide. Vérifiez la console pour les détails.');
    
    // Optionnel: soumettre réellement le formulaire
    // form.submit();
}

// Initialiser l'affichage au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing simplified form...');
    showExerciseType();
    
    // Ajouter gestionnaire d'événements pour le bouton "Ajouter un mot"
    // Chercher le bouton par son texte dans la section Mots mêlés
    const wordSearchSection = document.getElementById('word_search_section');
    if (wordSearchSection) {
        const addWordBtn = wordSearchSection.querySelector('button[onclick="addWord()"]');
        if (addWordBtn) {
            // Supprimer l'ancien onclick pour éviter les doublons
            addWordBtn.removeAttribute('onclick');
            
            addWordBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('[EVENT] Bouton Ajouter un mot cliqué via gestionnaire');
                addWord();
            });
            console.log('[INIT] Gestionnaire d\'événements ajouté au bouton Ajouter un mot');
        } else {
            console.error('[ERROR] Bouton Ajouter un mot non trouvé dans la section');
        }
    } else {
        console.error('[ERROR] Section word_search_section non trouvée');
    }
    
    // Écouter les changements de type d'exercice
    const exerciseTypeSelect = document.getElementById('exercise_type');
    if (exerciseTypeSelect) {
        exerciseTypeSelect.addEventListener('change', showExerciseType);
    }
});

// Fonctions pour Glisser-déposer
function addDragItem() {
    const container = document.getElementById('drag_items_container');
    const newItemDiv = document.createElement('div');
    newItemDiv.className = 'input-group mb-2';
    newItemDiv.innerHTML = `
        <input type="text" name="drag_items[]" class="form-control" placeholder="Entrez un élément à glisser" required>
        <button type="button" class="btn btn-danger" onclick="this.closest('.input-group').remove()">
            <i class="bi bi-trash"></i>
        </button>
    `;
    container.appendChild(newItemDiv);
}

function addDropZone() {
    const container = document.getElementById('drop_zones_container');
    const newZoneDiv = document.createElement('div');
    newZoneDiv.className = 'input-group mb-2';
    newZoneDiv.innerHTML = `
        <input type="text" name="drop_zones[]" class="form-control" placeholder="Entrez une zone de dépôt" required>
        <button type="button" class="btn btn-danger" onclick="this.closest('.input-group').remove()">
            <i class="bi bi-trash"></i>
        </button>
    `;
    container.appendChild(newZoneDiv);
}

// Fonctions pour Association de paires
function addPair() {
    const container = document.getElementById('pairs_container');
    const pairCount = container.children.length + 1;
    
    const newPairDiv = document.createElement('div');
    newPairDiv.className = 'pair-item mb-4 border p-3 rounded';
    newPairDiv.setAttribute('data-pair-id', pairCount);
    newPairDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5>Paire ${pairCount}</h5>
            <button type="button" class="btn btn-danger btn-sm" onclick="removePair(this)">
                <i class="bi bi-trash"></i> Supprimer
            </button>
        </div>
        <div class="row">
            <!-- Élément de gauche -->
            <div class="col-md-6">
                <label class="form-label">Élément de gauche</label>
                <div class="mb-2">
                    <select class="form-select pair-left-type" name="pair_left_type_${pairCount}" onchange="togglePairInput(this, 'left')">
                        <option value="text">Texte</option>
                        <option value="image">Image</option>
                    </select>
                </div>
                <div class="pair-left-text">
                    <input type="text" class="form-control" name="pair_left_${pairCount}" placeholder="Entrez le texte">
                </div>
                <div class="pair-left-image" style="display: none;">
                    <input type="file" class="form-control" name="pair_left_image_${pairCount}" accept="image/*">
                </div>
            </div>
            
            <!-- Élément de droite -->
            <div class="col-md-6">
                <label class="form-label">Élément de droite</label>
                <div class="mb-2">
                    <select class="form-select pair-right-type" name="pair_right_type_${pairCount}" onchange="togglePairInput(this, 'right')">
                        <option value="text">Texte</option>
                        <option value="image">Image</option>
                    </select>
                </div>
                <div class="pair-right-text">
                    <input type="text" class="form-control" name="pair_right_${pairCount}" placeholder="Entrez le texte">
                </div>
                <div class="pair-right-image" style="display: none;">
                    <input type="file" class="form-control" name="pair_right_image_${pairCount}" accept="image/*">
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(newPairDiv);
    updatePairLabels();
}

function removePair(button) {
    const pairItem = button.closest('.pair-item');
    pairItem.remove();
    updatePairLabels();
}

function updatePairLabels() {
    const pairItems = document.querySelectorAll('#pairs_container .pair-item');
    pairItems.forEach((item, index) => {
        const title = item.querySelector('h5');
        title.textContent = `Paire ${index + 1}`;
    });
}

function togglePairInput(selectElement, side) {
    const pairItem = selectElement.closest('.pair-item');
    const textDiv = pairItem.querySelector(`.pair-${side}-text`);
    const imageDiv = pairItem.querySelector(`.pair-${side}-image`);
    
    if (selectElement.value === 'text') {
        textDiv.style.display = 'block';
        imageDiv.style.display = 'none';
        // Vider le champ image
        const imageInput = imageDiv.querySelector('input[type="file"]');
        if (imageInput) imageInput.value = '';
    } else {
        textDiv.style.display = 'none';
        imageDiv.style.display = 'block';
        // Vider le champ texte
        const textInput = textDiv.querySelector('input[type="text"]');
        if (textInput) textInput.value = '';
    }
}

// Fonction pour ajouter une phrase de dictée
function addDictationSentence() {
    const container = document.getElementById('dictation_sentences_container');
    const currentItems = container.querySelectorAll('.dictation-item');
    const newIndex = currentItems.length;
    
    const newSentenceDiv = document.createElement('div');
    newSentenceDiv.className = 'dictation-item mb-4 p-3';
    newSentenceDiv.style.cssText = 'border: 1px solid #ddd; border-radius: 8px; background-color: #f8f9fa;';
    
    newSentenceDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5>Phrase ${newIndex + 1}</h5>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeDictationSentence(this)">
                <i class="bi bi-trash"></i> Supprimer
            </button>
        </div>
        <div class="row">
            <div class="col-md-8">
                <label class="form-label">Texte de la phrase</label>
                <input type="text" class="form-control" name="dictation_sentences[]" 
                       placeholder="Entrez la phrase à dicter" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Fichier audio (optionnel)</label>
                <input type="file" class="form-control" name="dictation_audio_${newIndex}" 
                       accept="audio/*" title="Uploadez un fichier audio MP3 ou WAV">
                <small class="text-muted">Formats acceptés : MP3, WAV</small>
            </div>
        </div>
    `;
    
    container.appendChild(newSentenceDiv);
}

// Fonction pour supprimer une phrase de dictée
function removeDictationSentence(button) {
    const dictationItem = button.closest('.dictation-item');
    dictationItem.remove();
    updateDictationLabels();
}

// Fonction pour mettre à jour les labels des phrases de dictée
function updateDictationLabels() {
    const container = document.getElementById('dictation_sentences_container');
    const items = container.querySelectorAll('.dictation-item');
    
    items.forEach((item, index) => {
        const title = item.querySelector('h5');
        title.textContent = `Phrase ${index + 1}`;
        
        // Mettre à jour le nom du champ audio
        const audioInput = item.querySelector('input[type="file"]');
        if (audioInput) {
            audioInput.name = `dictation_audio_${index}`;
        }
    });
}

// Fonction de soumission directe qui contourne toute validation
function directSubmit() {
    console.log('=== DIRECT SUBMIT - BYPASS ALL VALIDATION ===');
    
    const form = document.querySelector('form');
    
    if (!form) {
        console.error('Formulaire non trouvé!');
        alert('ERREUR: Formulaire non trouvé!');
        return;
    }
    
    console.log('Formulaire trouvé, soumission directe...');
    console.log('Action:', form.action);
    console.log('Method:', form.method);
    
    // Soumission directe sans validation
    try {
        form.submit();
        console.log('Formulaire soumis avec succès!');
    } catch (error) {
        console.error('Erreur lors de la soumission:', error);
        alert('ERREUR: ' + error.message);
    }
}

</script>
{% endblock content %}
