{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2>{{ exercise.title }}</h2>
            <p class="lead">{{ exercise.description }}</p>
        </div>
        {% if current_user.is_teacher %}
        <div class="btn-group">
            <a href="{{ url_for('edit_exercise', exercise_id=exercise.id) }}" class="btn btn-outline-primary">
                <i class="fas fa-edit"></i> Modifier
            </a>
            <form method="POST" action="{{ url_for('exercise.delete_exercise', exercise_id=exercise.id) }}" class="d-inline" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cet exercice ?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-outline-danger">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </form>
        </div>
        {% endif %}
    </div>

    <form method="POST" action="{{ url_for('submit_exercise_answer', exercise_id=exercise.id) }}" id="drag-drop-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        {% if course %}
        <input type="hidden" name="course_id" value="{{ course.id }}"/>
        {% endif %}
        
        <!-- Champs cachés pour les réponses -->
        {% for i in range(content.draggable_items|length) %}
        <input type="hidden" name="answer_{{ i }}" id="answer_{{ i }}" value="">
        {% endfor %}
        
        <div class="row mb-4">
            <div class="col-md-6">
                <h4>Éléments à placer</h4>
                <div class="draggable-container" id="draggable-items">
                    {% for item in content.draggable_items %}
                        <div class="card mb-2 draggable" draggable="true" data-index="{{ loop.index0 }}" id="item-{{ loop.index0 }}">
                            <div class="card-body d-flex align-items-center">
                                <i class="fas fa-grip-vertical me-2 text-muted"></i>
                                <span>{{ item }}</span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="col-md-6">
                <h4>Zones de dépôt</h4>
                <div class="droppable-container">
                    {% for i in range(content.draggable_items|length) %}
                        <div class="card mb-2 droppable" data-position="{{ loop.index0 }}" id="zone-{{ loop.index0 }}">
                            <div class="card-body">
                                <div class="drop-placeholder">Zone {{ loop.index }} - Déposez ici</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary" onclick="updateFormBeforeSubmit()">
            <i class="fas fa-check"></i> Valider mes réponses
        </button>
    </form>
</div>

<style>
.draggable-container {
    min-height: 50px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
}

.draggable {
    cursor: grab;
    user-select: none;
    background: white;
    margin-bottom: 8px;
    transition: all 0.2s;
}

.draggable:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.draggable.dragging {
    opacity: 0.5;
}

.droppable {
    min-height: 60px;
    border: 2px dashed #dee2e6;
    transition: all 0.2s;
}

.droppable.drag-over {
    border-color: #007bff;
    background-color: #f8f9ff;
}

.droppable.has-item {
    border-color: #28a745;
    background-color: #f8fff9;
}

.drop-placeholder {
    color: #6c757d;
    text-align: center;
    padding: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let draggedItem = null;
    
    const draggables = document.querySelectorAll('.draggable');
    const droppables = document.querySelectorAll('.droppable');
    
    console.log('Template drag_and_drop_fixed chargé');
    console.log(`Nombre d'éléments glissables: ${draggables.length}`);
    console.log(`Nombre de zones de dépôt: ${droppables.length}`);
    
    // Événements pour les éléments glissables
    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', (e) => {
            draggedItem = draggable;
            draggable.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggable.dataset.index);
            console.log(`Début glisser: élément ${draggable.dataset.index}`);
        });
        
        draggable.addEventListener('dragend', () => {
            draggable.classList.remove('dragging');
            draggedItem = null;
            updateZoneStyles();
        });
    });
    
    // Événements pour les zones de dépôt
    droppables.forEach(droppable => {
        droppable.addEventListener('dragover', (e) => {
            e.preventDefault();
            droppable.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
        });
        
        droppable.addEventListener('dragleave', (e) => {
            if (!droppable.contains(e.relatedTarget)) {
                droppable.classList.remove('drag-over');
            }
        });
        
        droppable.addEventListener('drop', (e) => {
            e.preventDefault();
            droppable.classList.remove('drag-over');
            
            if (!draggedItem) return;
            
            const zonePosition = droppable.dataset.position;
            const itemIndex = draggedItem.dataset.index;
            
            console.log(`Déposer élément ${itemIndex} dans zone ${zonePosition}`);
            
            // Gérer l'échange si la zone contient déjà un élément
            const existingItem = droppable.querySelector('.draggable');
            if (existingItem) {
                // Remettre l'élément existant dans la zone d'origine
                document.getElementById('draggable-items').appendChild(existingItem);
                console.log(`Élément ${existingItem.dataset.index} remis dans la zone d'origine`);
            }
            
            // Placer le nouvel élément dans la zone
            droppable.querySelector('.card-body').appendChild(draggedItem);
            
            // Mettre à jour le champ caché correspondant
            const hiddenInput = document.getElementById(`answer_${zonePosition}`);
            if (hiddenInput) {
                hiddenInput.value = itemIndex;
                console.log(`Champ answer_${zonePosition} mis à jour avec la valeur ${itemIndex}`);
            } else {
                console.error(`Champ caché answer_${zonePosition} introuvable!`);
            }
            
            updateZoneStyles();
            debugFormState();
        });
    });
    
    function updateZoneStyles() {
        droppables.forEach(droppable => {
            const hasItem = droppable.querySelector('.draggable') !== null;
            droppable.classList.toggle('has-item', hasItem);
        });
    }
    
    function debugFormState() {
        console.log('=== État des champs cachés ===');
        {% for i in range(content.draggable_items|length) %}
        const field{{ i }} = document.getElementById('answer_{{ i }}');
        console.log('answer_{{ i }}: "' + (field{{ i }} ? field{{ i }}.value : 'INTROUVABLE') + '"');
        {% endfor %}
    }
    
    // Fonction appelée avant soumission
    window.updateFormBeforeSubmit = function() {
        console.log('=== SOUMISSION DU FORMULAIRE ===');
        debugFormState();
        
        // Vérifier que tous les éléments sont placés
        let allPlaced = true;
        {% for i in range(content.draggable_items|length) %}
        const field{{ i }} = document.getElementById('answer_{{ i }}');
        if (!field{{ i }} || field{{ i }}.value === '') {
            allPlaced = false;
            console.warn(`Élément {{ i }} non placé`);
        }
        {% endfor %}
        
        if (!allPlaced) {
            alert('Veuillez placer tous les éléments dans les zones de dépôt.');
            return false;
        }
        
        return true;
    };
    
    // État initial
    updateZoneStyles();
    debugFormState();
});
</script>
{% endblock %}
